<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.25">
    <meta name="theme-color" content="#3eaf7c"><title>vue-router v4.0.12 | 朝花夕拾</title><meta name="description" content="">
    <link rel="modulepreload" href="/assets/app.11f00557.js"><link rel="modulepreload" href="/assets/code.html.006149c2.js"><link rel="modulepreload" href="/assets/code.html.e72c5649.js">
    <link rel="stylesheet" href="/assets/style.bf8ab0ef.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><img class="logo" src="/logo.png" alt="朝花夕拾"><span class="site-name can-hide">朝花夕拾</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/vue3Basic/" class="nav-link" aria-label="Vue3基础"><!--[--><!--]--> Vue3基础 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/sourceCode/" class="nav-link" aria-label="核心原理"><!--[--><!--]--> 核心原理 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/elementPlus/" class="nav-link" aria-label="ElementPlus"><!--[--><!--]--> ElementPlus <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="生态系统"><span class="title">生态系统</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="生态系统"><span class="title">生态系统</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/vuex/" class="nav-link" aria-label="Vuex"><!--[--><!--]--> Vuex <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/vueRouter/" class="nav-link router-link-active" aria-label="Vue Router"><!--[--><!--]--> Vue Router <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/vite/" class="nav-link" aria-label="Vite"><!--[--><!--]--> Vite <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/vuePress/" class="nav-link" aria-label="VuePress"><!--[--><!--]--> VuePress <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><!----><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><div class="sidebar-mask"></div><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/" class="nav-link" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/vue3Basic/" class="nav-link" aria-label="Vue3基础"><!--[--><!--]--> Vue3基础 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/sourceCode/" class="nav-link" aria-label="核心原理"><!--[--><!--]--> 核心原理 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/elementPlus/" class="nav-link" aria-label="ElementPlus"><!--[--><!--]--> ElementPlus <!--[--><!--]--></a></div><div class="navbar-links-item"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="生态系统"><span class="title">生态系统</span><span class="arrow down"></span></button><button class="mobile-dropdown-title" type="button" aria-label="生态系统"><span class="title">生态系统</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="nav-dropdown"><!--[--><li class="dropdown-item"><a href="/vuex/" class="nav-link" aria-label="Vuex"><!--[--><!--]--> Vuex <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/vueRouter/" class="nav-link router-link-active" aria-label="Vue Router"><!--[--><!--]--> Vue Router <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/vite/" class="nav-link" aria-label="Vite"><!--[--><!--]--> Vite <!--[--><!--]--></a></li><li class="dropdown-item"><a href="/vuePress/" class="nav-link" aria-label="VuePress"><!--[--><!--]--> VuePress <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><a href="/vueRouter/" class="nav-link router-link-active sidebar-heading sidebar-item" aria-label="Introduction"><!--[--><!--]--> Introduction <!--[--><!--]--></a><!----><!--]--><!--[--><a href="/vueRouter/application" class="nav-link sidebar-heading sidebar-item" aria-label="VueRouter 特性"><!--[--><!--]--> VueRouter 特性 <!--[--><!--]--></a><!----><!--]--><!--[--><a href="/vueRouter/browserRouter" class="nav-link sidebar-heading sidebar-item" aria-label="原生路由"><!--[--><!--]--> 原生路由 <!--[--><!--]--></a><!----><!--]--><!--[--><a href="/vueRouter/sourceCode" class="nav-link sidebar-heading sidebar-item" aria-label="源码解读"><!--[--><!--]--> 源码解读 <!--[--><!--]--></a><!----><!--]--><!--[--><a href="/vueRouter/code" class="nav-link router-link-active sidebar-heading sidebar-item active" aria-label="vue-router v4.0.12"><!--[--><!--]--> vue-router v4.0.12 <!--[--><!--]--></a><!----><!--]--><!--]--></ul><!--[--><!--]--></aside><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="vue-router-v4-0-12" tabindex="-1"><a class="header-anchor" href="#vue-router-v4-0-12" aria-hidden="true">#</a> vue-router v4.0.12</h1><p><code>vue-router.esm-browser.js</code></p><div class="language-javascript ext-js"><pre class="language-javascript"><code><span class="token comment">/*!
 * vue-router v4.0.12
 * (c) 2021 Eduardo San Martin Morote
 * @license MIT
 */</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>
  getCurrentInstance<span class="token punctuation">,</span>
  inject<span class="token punctuation">,</span>
  onUnmounted<span class="token punctuation">,</span>
  onDeactivated<span class="token punctuation">,</span>
  onActivated<span class="token punctuation">,</span>
  computed<span class="token punctuation">,</span>
  unref<span class="token punctuation">,</span>
  watchEffect<span class="token punctuation">,</span>
  defineComponent<span class="token punctuation">,</span>
  reactive<span class="token punctuation">,</span>
  h<span class="token punctuation">,</span>
  provide<span class="token punctuation">,</span>
  ref<span class="token punctuation">,</span>
  watch<span class="token punctuation">,</span>
  shallowRef<span class="token punctuation">,</span>
  nextTick<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> setupDevtoolsPlugin <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@vue/devtools-api&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> hasSymbol <span class="token operator">=</span>
  <span class="token keyword">typeof</span> Symbol <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Symbol<span class="token punctuation">.</span>toStringTag <span class="token operator">===</span> <span class="token string">&#39;symbol&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">PolySymbol</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token comment">// vr = vue router</span>
  hasSymbol <span class="token operator">?</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">&#39;[vue-router]: &#39;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&#39;[vue-router]: &#39;</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
<span class="token comment">// rvlm = Router View Location Matched</span>
<span class="token doc-comment comment">/**
 * RouteRecord being rendered by the closest ancestor Router View. Used for
 * `onBeforeRouteUpdate` and `onBeforeRouteLeave`. rvlm stands for Router View
 * Location Matched
 *
 * <span class="token keyword">@internal</span>
 */</span>
<span class="token keyword">const</span> matchedRouteKey <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">PolySymbol</span><span class="token punctuation">(</span>
  <span class="token string">&#39;router view location matched&#39;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * Allows overriding the router view depth to control which component in
 * `matched` is rendered. rvd stands for Router View Depth
 *
 * <span class="token keyword">@internal</span>
 */</span>
<span class="token keyword">const</span> viewDepthKey <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">PolySymbol</span><span class="token punctuation">(</span><span class="token string">&#39;router view depth&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * Allows overriding the router instance returned by `useRouter` in tests. r
 * stands for router
 *
 * <span class="token keyword">@internal</span>
 */</span>
<span class="token keyword">const</span> routerKey <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">PolySymbol</span><span class="token punctuation">(</span><span class="token string">&#39;router&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * Allows overriding the current route returned by `useRoute` in tests. rl
 * stands for route location
 *
 * <span class="token keyword">@internal</span>
 */</span>
<span class="token keyword">const</span> routeLocationKey <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">PolySymbol</span><span class="token punctuation">(</span><span class="token string">&#39;route location&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * Allows overriding the current route used by router-view. Internally this is
 * used when the `route` prop is passed.
 *
 * <span class="token keyword">@internal</span>
 */</span>
<span class="token keyword">const</span> routerViewLocationKey <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">PolySymbol</span><span class="token punctuation">(</span><span class="token string">&#39;router view location&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> isBrowser <span class="token operator">=</span> <span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">&#39;undefined&#39;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">isESModule</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> obj<span class="token punctuation">.</span>__esModule <span class="token operator">||</span> <span class="token punctuation">(</span>hasSymbol <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">[</span>Symbol<span class="token punctuation">.</span>toStringTag<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;Module&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> assign <span class="token operator">=</span> Object<span class="token punctuation">.</span>assign<span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">applyToParams</span><span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newParams <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    newParams<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> value<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">fn</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> newParams<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">noop</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">warn</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// avoid using ...args as it breaks in older Edge builds</span>
  <span class="token keyword">const</span> args <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>console<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">&#39;[Vue Router warn]: &#39;</span> <span class="token operator">+</span> msg<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token constant">TRAILING_SLASH_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">removeTrailingSlash</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> path<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">TRAILING_SLASH_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * Transforms an URI into a normalized history location
 *
 * <span class="token keyword">@param</span> <span class="token parameter">parseQuery</span>
 * <span class="token keyword">@param</span> <span class="token parameter">location</span> - URI to normalize
 * <span class="token keyword">@param</span> <span class="token parameter">currentLocation</span> - current absolute location. Allows resolving relative
 * paths. Must start with `/`. Defaults to `/`
 * <span class="token keyword">@returns</span> a normalized history location
 */</span>
<span class="token keyword">function</span> <span class="token function">parseURL</span><span class="token punctuation">(</span>parseQuery<span class="token punctuation">,</span> location<span class="token punctuation">,</span> currentLocation <span class="token operator">=</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> path<span class="token punctuation">,</span>
    query <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    searchString <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
    hash <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
  <span class="token comment">// Could use URL and URLSearchParams but IE 11 doesn&#39;t support it</span>
  <span class="token keyword">const</span> searchPos <span class="token operator">=</span> location<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&#39;?&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> hashPos <span class="token operator">=</span> location<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&#39;#&#39;</span><span class="token punctuation">,</span> searchPos <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> searchPos <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>searchPos <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    path <span class="token operator">=</span> location<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> searchPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    searchString <span class="token operator">=</span> location<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>
      searchPos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
      hashPos <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> hashPos <span class="token operator">:</span> location<span class="token punctuation">.</span>length
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    query <span class="token operator">=</span> <span class="token function">parseQuery</span><span class="token punctuation">(</span>searchString<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hashPos <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    path <span class="token operator">=</span> path <span class="token operator">||</span> location<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> hashPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// keep the # character</span>
    hash <span class="token operator">=</span> location<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>hashPos<span class="token punctuation">,</span> location<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// no search and no query</span>
  path <span class="token operator">=</span> <span class="token function">resolveRelativePath</span><span class="token punctuation">(</span>path <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> path <span class="token operator">:</span> location<span class="token punctuation">,</span> currentLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// empty path means a relative query or hash `?foo=f`, `#thing`</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    fullPath<span class="token operator">:</span> path <span class="token operator">+</span> <span class="token punctuation">(</span>searchString <span class="token operator">&amp;&amp;</span> <span class="token string">&#39;?&#39;</span><span class="token punctuation">)</span> <span class="token operator">+</span> searchString <span class="token operator">+</span> hash<span class="token punctuation">,</span>
    path<span class="token punctuation">,</span>
    query<span class="token punctuation">,</span>
    hash<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Stringifies a URL object
 *
 * <span class="token keyword">@param</span> <span class="token parameter">stringifyQuery</span>
 * <span class="token keyword">@param</span> <span class="token parameter">location</span>
 */</span>
<span class="token keyword">function</span> <span class="token function">stringifyURL</span><span class="token punctuation">(</span><span class="token parameter">stringifyQuery<span class="token punctuation">,</span> location</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> query <span class="token operator">=</span> location<span class="token punctuation">.</span>query <span class="token operator">?</span> <span class="token function">stringifyQuery</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>query<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> location<span class="token punctuation">.</span>path <span class="token operator">+</span> <span class="token punctuation">(</span>query <span class="token operator">&amp;&amp;</span> <span class="token string">&#39;?&#39;</span><span class="token punctuation">)</span> <span class="token operator">+</span> query <span class="token operator">+</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>hash <span class="token operator">||</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Strips off the base from the beginning of a location.pathname in a non
 * case-sensitive way.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">pathname</span> - location.pathname
 * <span class="token keyword">@param</span> <span class="token parameter">base</span> - base to strip off
 */</span>
<span class="token keyword">function</span> <span class="token function">stripBase</span><span class="token punctuation">(</span><span class="token parameter">pathname<span class="token punctuation">,</span> base</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// no base or base is not found at the beginning</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>base <span class="token operator">||</span> <span class="token operator">!</span>pathname<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> pathname<span class="token punctuation">;</span>
  <span class="token keyword">return</span> pathname<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Checks if two RouteLocation are equal. This means that both locations are
 * pointing towards the same <span class="token punctuation">{</span><span class="token keyword">@link</span> RouteRecord<span class="token punctuation">}</span> and that all `params`, `query`
 * parameters and `hash` are the same
 *
 * <span class="token keyword">@param</span> <span class="token parameter">a</span> - first <span class="token punctuation">{</span><span class="token keyword">@link</span> RouteLocation<span class="token punctuation">}</span>
 * <span class="token keyword">@param</span> <span class="token parameter">b</span> - second <span class="token punctuation">{</span><span class="token keyword">@link</span> RouteLocation<span class="token punctuation">}</span>
 */</span>
<span class="token keyword">function</span> <span class="token function">isSameRouteLocation</span><span class="token punctuation">(</span><span class="token parameter">stringifyQuery<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> aLastIndex <span class="token operator">=</span> a<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> bLastIndex <span class="token operator">=</span> b<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    aLastIndex <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
    aLastIndex <span class="token operator">===</span> bLastIndex <span class="token operator">&amp;&amp;</span>
    <span class="token function">isSameRouteRecord</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>aLastIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>bLastIndex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token function">isSameRouteLocationParams</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>params<span class="token punctuation">,</span> b<span class="token punctuation">.</span>params<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token function">stringifyQuery</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>query<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">stringifyQuery</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>query<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    a<span class="token punctuation">.</span>hash <span class="token operator">===</span> b<span class="token punctuation">.</span>hash
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Check if two `RouteRecords` are equal. Takes into account aliases: they are
 * considered equal to the `RouteRecord` they are aliasing.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">a</span> - first <span class="token punctuation">{</span><span class="token keyword">@link</span> RouteRecord<span class="token punctuation">}</span>
 * <span class="token keyword">@param</span> <span class="token parameter">b</span> - second <span class="token punctuation">{</span><span class="token keyword">@link</span> RouteRecord<span class="token punctuation">}</span>
 */</span>
<span class="token keyword">function</span> <span class="token function">isSameRouteRecord</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// since the original record has an undefined value for aliasOf</span>
  <span class="token comment">// but all aliases point to the original record, this will always compare</span>
  <span class="token comment">// the original record</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>aliasOf <span class="token operator">||</span> a<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token punctuation">(</span>b<span class="token punctuation">.</span>aliasOf <span class="token operator">||</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">isSameRouteLocationParams</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">!==</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isSameRouteLocationParamsValue</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">isSameRouteLocationParamsValue</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token operator">?</span> <span class="token function">isEquivalentArray</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
    <span class="token operator">:</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    <span class="token operator">?</span> <span class="token function">isEquivalentArray</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
    <span class="token operator">:</span> a <span class="token operator">===</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Check if two arrays are the same or if an array with one single entry is the
 * same as another primitive value. Used to check query and parameters
 *
 * <span class="token keyword">@param</span> <span class="token parameter">a</span> - array of values
 * <span class="token keyword">@param</span> <span class="token parameter">b</span> - array of values or a single value
 */</span>
<span class="token keyword">function</span> <span class="token function">isEquivalentArray</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
    <span class="token operator">?</span> a<span class="token punctuation">.</span>length <span class="token operator">===</span> b<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> value <span class="token operator">===</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token operator">:</span> a<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Resolves a relative path that starts with `.`.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">to</span> - path location we are resolving
 * <span class="token keyword">@param</span> <span class="token parameter">from</span> - currentLocation.path, should start with `/`
 */</span>
<span class="token keyword">function</span> <span class="token function">resolveRelativePath</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> to<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>from<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warn</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Cannot resolve a relative location without an absolute path. Trying to resolve &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>to<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">from</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. It should look like &quot;/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">from</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> to<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>to<span class="token punctuation">)</span> <span class="token keyword">return</span> from<span class="token punctuation">;</span>
  <span class="token keyword">const</span> fromSegments <span class="token operator">=</span> from<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> toSegments <span class="token operator">=</span> to<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> position <span class="token operator">=</span> fromSegments<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> toPosition<span class="token punctuation">;</span>
  <span class="token keyword">let</span> segment<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>toPosition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> toPosition <span class="token operator">&lt;</span> toSegments<span class="token punctuation">.</span>length<span class="token punctuation">;</span> toPosition<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    segment <span class="token operator">=</span> toSegments<span class="token punctuation">[</span>toPosition<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// can&#39;t go below zero</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>position <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">||</span> segment <span class="token operator">===</span> <span class="token string">&#39;.&#39;</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>segment <span class="token operator">===</span> <span class="token string">&#39;..&#39;</span><span class="token punctuation">)</span> position<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token comment">// found something that is not relative path</span>
    <span class="token keyword">else</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    fromSegments<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> position<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token operator">+</span>
    <span class="token string">&#39;/&#39;</span> <span class="token operator">+</span>
    toSegments
      <span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>toPosition <span class="token operator">-</span> <span class="token punctuation">(</span>toPosition <span class="token operator">===</span> toSegments<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> NavigationType<span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">NavigationType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  NavigationType<span class="token punctuation">[</span><span class="token string">&#39;pop&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;pop&#39;</span><span class="token punctuation">;</span>
  NavigationType<span class="token punctuation">[</span><span class="token string">&#39;push&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;push&#39;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NavigationType <span class="token operator">||</span> <span class="token punctuation">(</span>NavigationType <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> NavigationDirection<span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">NavigationDirection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  NavigationDirection<span class="token punctuation">[</span><span class="token string">&#39;back&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;back&#39;</span><span class="token punctuation">;</span>
  NavigationDirection<span class="token punctuation">[</span><span class="token string">&#39;forward&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;forward&#39;</span><span class="token punctuation">;</span>
  NavigationDirection<span class="token punctuation">[</span><span class="token string">&#39;unknown&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NavigationDirection <span class="token operator">||</span> <span class="token punctuation">(</span>NavigationDirection <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * Starting location for Histories
 */</span>
<span class="token keyword">const</span> <span class="token constant">START</span> <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
<span class="token comment">// Generic utils</span>
<span class="token doc-comment comment">/**
 * Normalizes a base by removing any trailing slash and reading the base tag if
 * present.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">base</span> - base to normalize
 */</span>
<span class="token keyword">function</span> <span class="token function">normalizeBase</span><span class="token punctuation">(</span><span class="token parameter">base</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>base<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// respect &lt;base&gt; tag</span>
      <span class="token keyword">const</span> baseEl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;base&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      base <span class="token operator">=</span> <span class="token punctuation">(</span>baseEl <span class="token operator">&amp;&amp;</span> baseEl<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">&#39;href&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">;</span>
      <span class="token comment">// strip full URL origin</span>
      base <span class="token operator">=</span> base<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\w+:\/\/[^\/]+</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      base <span class="token operator">=</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ensure leading slash when it was removed by the regex above avoid leading</span>
  <span class="token comment">// slash with hash because the file could be read from the disk like file://</span>
  <span class="token comment">// and the leading slash would cause problems</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>base<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">&amp;&amp;</span> base<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">&#39;#&#39;</span><span class="token punctuation">)</span> base <span class="token operator">=</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">+</span> base<span class="token punctuation">;</span>
  <span class="token comment">// remove the trailing slash so all other method can just do `base + fullPath`</span>
  <span class="token comment">// to build an href</span>
  <span class="token keyword">return</span> <span class="token function">removeTrailingSlash</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// remove any character before the hash</span>
<span class="token keyword">const</span> <span class="token constant">BEFORE_HASH_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^[^#]+#</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">createHref</span><span class="token punctuation">(</span><span class="token parameter">base<span class="token punctuation">,</span> location</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> base<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">BEFORE_HASH_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;#&#39;</span><span class="token punctuation">)</span> <span class="token operator">+</span> location<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">getElementPosition</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> offset</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> docRect <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> elRect <span class="token operator">=</span> el<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    behavior<span class="token operator">:</span> offset<span class="token punctuation">.</span>behavior<span class="token punctuation">,</span>
    left<span class="token operator">:</span> elRect<span class="token punctuation">.</span>left <span class="token operator">-</span> docRect<span class="token punctuation">.</span>left <span class="token operator">-</span> <span class="token punctuation">(</span>offset<span class="token punctuation">.</span>left <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    top<span class="token operator">:</span> elRect<span class="token punctuation">.</span>top <span class="token operator">-</span> docRect<span class="token punctuation">.</span>top <span class="token operator">-</span> <span class="token punctuation">(</span>offset<span class="token punctuation">.</span>top <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">computeScrollPosition</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  left<span class="token operator">:</span> window<span class="token punctuation">.</span>pageXOffset<span class="token punctuation">,</span>
  top<span class="token operator">:</span> window<span class="token punctuation">.</span>pageYOffset<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">scrollToPosition</span><span class="token punctuation">(</span><span class="token parameter">position</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> scrollToOptions<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&#39;el&#39;</span> <span class="token keyword">in</span> position<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> positionEl <span class="token operator">=</span> position<span class="token punctuation">.</span>el<span class="token punctuation">;</span>
    <span class="token keyword">const</span> isIdSelector <span class="token operator">=</span>
      <span class="token keyword">typeof</span> positionEl <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">&amp;&amp;</span> positionEl<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;#&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * `id`s can accept pretty much any characters, including CSS combinators
     * like `&gt;` or `~`. It&#39;s still possible to retrieve elements using
     * `document.getElementById(&#39;~&#39;)` but it needs to be escaped when using
     * `document.querySelector(&#39;#\\~&#39;)` for it to be valid. The only
     * requirements for `id`s are them to be unique on the page and to not be
     * empty (`id=&quot;&quot;`). Because of that, when passing an id selector, it should
     * be properly escaped for it to work with `querySelector`. We could check
     * for the id selector to be simple (no CSS combinators `+ &gt;~`) but that
     * would make things inconsistent since they are valid characters for an
     * `id` but would need to be escaped when using `querySelector`, breaking
     * their usage and ending up in no selector returned. Selectors need to be
     * escaped:
     *
     * - `#1-thing` becomes `#\31 -thing`
     * - `#with~symbols` becomes `#with\\~symbols`
     *
     * - More information about  the topic can be found at
     *   https://mathiasbynens.be/notes/html5-id-class.
     * - Practical example: https://mathiasbynens.be/demo/html5-id
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> position<span class="token punctuation">.</span>el <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isIdSelector <span class="token operator">||</span> <span class="token operator">!</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span>el<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> foundEl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>isIdSelector <span class="token operator">&amp;&amp;</span> foundEl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">warn</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The selector &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span>el<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; should be passed as &quot;el: document.querySelector(&#39;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span>el<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&#39;)&quot; because it starts with &quot;#&quot;.</span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// return to avoid other warnings</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span>
            <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The selector &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span>el<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is invalid. If you are using an id selector, make sure to escape it. You can find more information about escaping characters in selectors at https://mathiasbynens.be/notes/css-escapes or use CSS.escape (https://developer.mozilla.org/en-US/docs/Web/API/CSS/escape).</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// return to avoid other warnings</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> el <span class="token operator">=</span>
      <span class="token keyword">typeof</span> positionEl <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span>
        <span class="token operator">?</span> isIdSelector
          <span class="token operator">?</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>positionEl<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token operator">:</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>positionEl<span class="token punctuation">)</span>
        <span class="token operator">:</span> positionEl<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>el<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Couldn&#39;t find element using selector &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>position<span class="token punctuation">.</span>el<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; returned by scrollBehavior.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    scrollToOptions <span class="token operator">=</span> <span class="token function">getElementPosition</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> position<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    scrollToOptions <span class="token operator">=</span> position<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&#39;scrollBehavior&#39;</span> <span class="token keyword">in</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>style<span class="token punctuation">)</span>
    window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span>scrollToOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span>
      scrollToOptions<span class="token punctuation">.</span>left <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> scrollToOptions<span class="token punctuation">.</span>left <span class="token operator">:</span> window<span class="token punctuation">.</span>pageXOffset<span class="token punctuation">,</span>
      scrollToOptions<span class="token punctuation">.</span>top <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> scrollToOptions<span class="token punctuation">.</span>top <span class="token operator">:</span> window<span class="token punctuation">.</span>pageYOffset
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getScrollKey</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> delta</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> position <span class="token operator">=</span> history<span class="token punctuation">.</span>state <span class="token operator">?</span> history<span class="token punctuation">.</span>state<span class="token punctuation">.</span>position <span class="token operator">-</span> delta <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> position <span class="token operator">+</span> path<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> scrollPositions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">saveScrollPosition</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> scrollPosition</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  scrollPositions<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> scrollPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">getSavedScrollPosition</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> scroll <span class="token operator">=</span> scrollPositions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// consume it so it&#39;s not used again</span>
  scrollPositions<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> scroll<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// TODO: RFC about how to save scroll position</span>
<span class="token doc-comment comment">/**
 * ScrollBehavior instance used by the router to compute and restore the scroll
 * position when navigating.
 */</span>
<span class="token comment">// export interface ScrollHandler&lt;ScrollPositionEntry extends HistoryStateValue, ScrollPosition extends ScrollPositionEntry&gt; {</span>
<span class="token comment">//   // returns a scroll position that can be saved in history</span>
<span class="token comment">//   compute(): ScrollPositionEntry</span>
<span class="token comment">//   // can take an extended ScrollPositionEntry</span>
<span class="token comment">//   scroll(position: ScrollPosition): void</span>
<span class="token comment">// }</span>
<span class="token comment">// export const scrollHandler: ScrollHandler&lt;ScrollPosition&gt; = {</span>
<span class="token comment">//   compute: computeScroll,</span>
<span class="token comment">//   scroll: scrollToPosition,</span>
<span class="token comment">// }</span>

<span class="token keyword">let</span> <span class="token function-variable function">createBaseLocation</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> location<span class="token punctuation">.</span>protocol <span class="token operator">+</span> <span class="token string">&#39;//&#39;</span> <span class="token operator">+</span> location<span class="token punctuation">.</span>host<span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * Creates a normalized history location from a window.location object
 * <span class="token keyword">@param</span> <span class="token parameter">location</span> -
 */</span>
<span class="token keyword">function</span> <span class="token function">createCurrentLocation</span><span class="token punctuation">(</span><span class="token parameter">base<span class="token punctuation">,</span> location</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pathname<span class="token punctuation">,</span> search<span class="token punctuation">,</span> hash <span class="token punctuation">}</span> <span class="token operator">=</span> location<span class="token punctuation">;</span>
  <span class="token comment">// allows hash bases like #, /#, #/, #!, #!/, /#!/, or even /folder#end</span>
  <span class="token keyword">const</span> hashPos <span class="token operator">=</span> base<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&#39;#&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hashPos <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> slicePos <span class="token operator">=</span> hash<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>base<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>hashPos<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token operator">?</span> base<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>hashPos<span class="token punctuation">)</span><span class="token punctuation">.</span>length
      <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> pathFromHash <span class="token operator">=</span> hash<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>slicePos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// prepend the starting slash to hash so the url starts with /#</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pathFromHash<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> pathFromHash <span class="token operator">=</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">+</span> pathFromHash<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">stripBase</span><span class="token punctuation">(</span>pathFromHash<span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">stripBase</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> base<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> path <span class="token operator">+</span> search <span class="token operator">+</span> hash<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">useHistoryListeners</span><span class="token punctuation">(</span><span class="token parameter">base<span class="token punctuation">,</span> historyState<span class="token punctuation">,</span> currentLocation<span class="token punctuation">,</span> replace</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> teardowns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// TODO: should it be a stack? a Dict. Check if the popstate listener</span>
  <span class="token comment">// can trigger twice</span>
  <span class="token keyword">let</span> pauseState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token function-variable function">popStateHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> state <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> to <span class="token operator">=</span> <span class="token function">createCurrentLocation</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> from <span class="token operator">=</span> currentLocation<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">const</span> fromState <span class="token operator">=</span> historyState<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">let</span> delta <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentLocation<span class="token punctuation">.</span>value <span class="token operator">=</span> to<span class="token punctuation">;</span>
      historyState<span class="token punctuation">.</span>value <span class="token operator">=</span> state<span class="token punctuation">;</span>
      <span class="token comment">// ignore the popstate and reset the pauseState</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>pauseState <span class="token operator">&amp;&amp;</span> pauseState <span class="token operator">===</span> from<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pauseState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      delta <span class="token operator">=</span> fromState <span class="token operator">?</span> state<span class="token punctuation">.</span>position <span class="token operator">-</span> fromState<span class="token punctuation">.</span>position <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">replace</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// console.log({ deltaFromCurrent })</span>
    <span class="token comment">// Here we could also revert the navigation by calling history.go(-delta)</span>
    <span class="token comment">// this listener will have to be adapted to not trigger again and to wait for the url</span>
    <span class="token comment">// to be updated before triggering the listeners. Some kind of validation function would also</span>
    <span class="token comment">// need to be passed to the listeners so the navigation can be accepted</span>
    <span class="token comment">// call all listeners</span>
    listeners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">listener</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">listener</span><span class="token punctuation">(</span>currentLocation<span class="token punctuation">.</span>value<span class="token punctuation">,</span> from<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        delta<span class="token punctuation">,</span>
        type<span class="token operator">:</span> NavigationType<span class="token punctuation">.</span>pop<span class="token punctuation">,</span>
        direction<span class="token operator">:</span> delta
          <span class="token operator">?</span> delta <span class="token operator">&gt;</span> <span class="token number">0</span>
            <span class="token operator">?</span> NavigationDirection<span class="token punctuation">.</span>forward
            <span class="token operator">:</span> NavigationDirection<span class="token punctuation">.</span>back
          <span class="token operator">:</span> NavigationDirection<span class="token punctuation">.</span>unknown<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">pauseListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pauseState <span class="token operator">=</span> currentLocation<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// setup the listener and prepare teardown callbacks</span>
    listeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">teardown</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> index <span class="token operator">=</span> listeners<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> listeners<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    teardowns<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>teardown<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> teardown<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">beforeUnloadListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> history <span class="token punctuation">}</span> <span class="token operator">=</span> window<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>history<span class="token punctuation">.</span>state<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    history<span class="token punctuation">.</span><span class="token function">replaceState</span><span class="token punctuation">(</span>
      <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> history<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token punctuation">{</span> scroll<span class="token operator">:</span> <span class="token function">computeScrollPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&#39;&#39;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> teardown <span class="token keyword">of</span> teardowns<span class="token punctuation">)</span> <span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    teardowns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;popstate&#39;</span><span class="token punctuation">,</span> popStateHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;beforeunload&#39;</span><span class="token punctuation">,</span> beforeUnloadListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// setup the listeners and prepare teardown callbacks</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;popstate&#39;</span><span class="token punctuation">,</span> popStateHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;beforeunload&#39;</span><span class="token punctuation">,</span> beforeUnloadListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    pauseListeners<span class="token punctuation">,</span>
    listen<span class="token punctuation">,</span>
    destroy<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Creates a state object
 */</span>
<span class="token keyword">function</span> <span class="token function">buildState</span><span class="token punctuation">(</span>
  <span class="token parameter">back<span class="token punctuation">,</span>
  current<span class="token punctuation">,</span>
  forward<span class="token punctuation">,</span>
  replaced <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  computeScroll <span class="token operator">=</span> <span class="token boolean">false</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    back<span class="token punctuation">,</span>
    current<span class="token punctuation">,</span>
    forward<span class="token punctuation">,</span>
    replaced<span class="token punctuation">,</span>
    position<span class="token operator">:</span> window<span class="token punctuation">.</span>history<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
    scroll<span class="token operator">:</span> computeScroll <span class="token operator">?</span> <span class="token function">computeScrollPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">useHistoryStateNavigation</span><span class="token punctuation">(</span><span class="token parameter">base</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> history<span class="token punctuation">,</span> location <span class="token punctuation">}</span> <span class="token operator">=</span> window<span class="token punctuation">;</span>
  <span class="token comment">// private variables</span>
  <span class="token keyword">const</span> currentLocation <span class="token operator">=</span> <span class="token punctuation">{</span>
    value<span class="token operator">:</span> <span class="token function">createCurrentLocation</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> historyState <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> history<span class="token punctuation">.</span>state <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// build current history entry as this is a fresh navigation</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>historyState<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">changeLocation</span><span class="token punctuation">(</span>
      currentLocation<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        back<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        current<span class="token operator">:</span> currentLocation<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
        forward<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token comment">// the length is off by one, we need to decrease it</span>
        position<span class="token operator">:</span> history<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>
        replaced<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token comment">// don&#39;t add a scroll as the user may have an anchor and we want</span>
        <span class="token comment">// scrollBehavior to be triggered without a saved position</span>
        scroll<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token boolean">true</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">changeLocation</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> state<span class="token punctuation">,</span> replace</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token doc-comment comment">/**
     * if a base tag is provided and we are on a normal domain, we have to
     * respect the provided `base` attribute because pushState() will use it and
     * potentially erase anything before the `#` like at
     * https://github.com/vuejs/vue-router-next/issues/685 where a base of
     * `/folder/#` but a base of `/` would erase the `/folder/` section. If
     * there is no host, the `&lt;base&gt;` tag makes no sense and if there isn&#39;t a
     * base tag we can just use everything after the `#`.
     */</span>
    <span class="token keyword">const</span> hashIndex <span class="token operator">=</span> base<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&#39;#&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span>
      hashIndex <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span>
        <span class="token operator">?</span> <span class="token punctuation">(</span>location<span class="token punctuation">.</span>host <span class="token operator">&amp;&amp;</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&#39;base&#39;</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> base
            <span class="token operator">:</span> base<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>hashIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> to
        <span class="token operator">:</span> <span class="token function">createBaseLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> base <span class="token operator">+</span> to<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// BROWSER QUIRK</span>
      <span class="token comment">// NOTE: Safari throws a SecurityError when calling this function 100 times in 30 seconds</span>
      history<span class="token punctuation">[</span>replace <span class="token operator">?</span> <span class="token string">&#39;replaceState&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;pushState&#39;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
      historyState<span class="token punctuation">.</span>value <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&#39;Error with push/replace State&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Force the navigation, this also resets the call count</span>
      location<span class="token punctuation">[</span>replace <span class="token operator">?</span> <span class="token string">&#39;replace&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;assign&#39;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      history<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
      <span class="token function">buildState</span><span class="token punctuation">(</span>
        historyState<span class="token punctuation">.</span>value<span class="token punctuation">.</span>back<span class="token punctuation">,</span>
        <span class="token comment">// keep back and forward entries but override current position</span>
        to<span class="token punctuation">,</span>
        historyState<span class="token punctuation">.</span>value<span class="token punctuation">.</span>forward<span class="token punctuation">,</span>
        <span class="token boolean">true</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      data<span class="token punctuation">,</span>
      <span class="token punctuation">{</span> position<span class="token operator">:</span> historyState<span class="token punctuation">.</span>value<span class="token punctuation">.</span>position <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">changeLocation</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentLocation<span class="token punctuation">.</span>value <span class="token operator">=</span> to<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Add to current entry the information of where we are going</span>
    <span class="token comment">// as well as saving the current position</span>
    <span class="token keyword">const</span> currentState <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// use current history state to gracefully handle a wrong call to</span>
      <span class="token comment">// history.replaceState</span>
      <span class="token comment">// https://github.com/vuejs/vue-router-next/issues/366</span>
      historyState<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      history<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        forward<span class="token operator">:</span> to<span class="token punctuation">,</span>
        scroll<span class="token operator">:</span> <span class="token function">computeScrollPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>history<span class="token punctuation">.</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">history.state seems to have been manually replaced without preserving the necessary values. Make sure to preserve existing history state if you are manually calling history.replaceState:\n\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">history.replaceState(history.state, &#39;&#39;, url)\n\n</span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">You can find more information at https://next.router.vuejs.org/guide/migration/#usage-of-history-state.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">changeLocation</span><span class="token punctuation">(</span>currentState<span class="token punctuation">.</span>current<span class="token punctuation">,</span> currentState<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">buildState</span><span class="token punctuation">(</span>currentLocation<span class="token punctuation">.</span>value<span class="token punctuation">,</span> to<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> position<span class="token operator">:</span> currentState<span class="token punctuation">.</span>position <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      data
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">changeLocation</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentLocation<span class="token punctuation">.</span>value <span class="token operator">=</span> to<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    location<span class="token operator">:</span> currentLocation<span class="token punctuation">,</span>
    state<span class="token operator">:</span> historyState<span class="token punctuation">,</span>
    push<span class="token punctuation">,</span>
    replace<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Creates an HTML5 history. Most common history for single page applications.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">base</span> -
 */</span>
<span class="token keyword">function</span> <span class="token function">createWebHistory</span><span class="token punctuation">(</span><span class="token parameter">base</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  base <span class="token operator">=</span> <span class="token function">normalizeBase</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> historyNavigation <span class="token operator">=</span> <span class="token function">useHistoryStateNavigation</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> historyListeners <span class="token operator">=</span> <span class="token function">useHistoryListeners</span><span class="token punctuation">(</span>
    base<span class="token punctuation">,</span>
    historyNavigation<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
    historyNavigation<span class="token punctuation">.</span>location<span class="token punctuation">,</span>
    historyNavigation<span class="token punctuation">.</span>replace
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token parameter">delta<span class="token punctuation">,</span> triggerListeners <span class="token operator">=</span> <span class="token boolean">true</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>triggerListeners<span class="token punctuation">)</span> historyListeners<span class="token punctuation">.</span><span class="token function">pauseListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    history<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> routerHistory <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// it&#39;s overridden right after</span>
      location<span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
      base<span class="token punctuation">,</span>
      go<span class="token punctuation">,</span>
      createHref<span class="token operator">:</span> <span class="token function">createHref</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> base<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    historyNavigation<span class="token punctuation">,</span>
    historyListeners
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>routerHistory<span class="token punctuation">,</span> <span class="token string">&#39;location&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> historyNavigation<span class="token punctuation">.</span>location<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>routerHistory<span class="token punctuation">,</span> <span class="token string">&#39;state&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> historyNavigation<span class="token punctuation">.</span>state<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> routerHistory<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * Creates a in-memory based history. The main purpose of this history is to handle SSR. It starts in a special location that is nowhere.
 * It&#39;s up to the user to replace that location with the starter location by either calling `router.push` or `router.replace`.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">base</span> - Base applied to all urls, defaults to &#39;/&#39;
 * <span class="token keyword">@returns</span> a history object that can be passed to the router constructor
 */</span>
<span class="token keyword">function</span> <span class="token function">createMemoryHistory</span><span class="token punctuation">(</span>base <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token constant">START</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  base <span class="token operator">=</span> <span class="token function">normalizeBase</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">setLocation</span><span class="token punctuation">(</span><span class="token parameter">location</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    position<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>position <span class="token operator">===</span> queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// we are at the end, we can simply append a new entry</span>
      queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// we are in the middle, we remove everything from here in the queue</span>
      queue<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">;</span>
      queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">triggerListeners</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> <span class="token punctuation">{</span> direction<span class="token punctuation">,</span> delta <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token punctuation">{</span>
      direction<span class="token punctuation">,</span>
      delta<span class="token punctuation">,</span>
      type<span class="token operator">:</span> NavigationType<span class="token punctuation">.</span>pop<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> callback <span class="token keyword">of</span> listeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> routerHistory <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// rewritten by Object.defineProperty</span>
    location<span class="token operator">:</span> <span class="token constant">START</span><span class="token punctuation">,</span>
    <span class="token comment">// TODO: should be kept in queue</span>
    state<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    base<span class="token punctuation">,</span>
    createHref<span class="token operator">:</span> <span class="token function">createHref</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> base<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">replace</span><span class="token punctuation">(</span><span class="token parameter">to</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// remove current entry and decrement position</span>
      queue<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>position<span class="token operator">--</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">setLocation</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setLocation</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      listeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> index <span class="token operator">=</span> listeners<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> listeners<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      queue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token constant">START</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">go</span><span class="token punctuation">(</span><span class="token parameter">delta<span class="token punctuation">,</span> shouldTrigger <span class="token operator">=</span> <span class="token boolean">true</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> from <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>location<span class="token punctuation">;</span>
      <span class="token keyword">const</span> direction <span class="token operator">=</span>
        <span class="token comment">// we are considering delta === 0 going forward, but in abstract mode</span>
        <span class="token comment">// using 0 for the delta doesn&#39;t make sense like it does in html5 where</span>
        <span class="token comment">// it reloads the page</span>
        delta <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> NavigationDirection<span class="token punctuation">.</span>back <span class="token operator">:</span> NavigationDirection<span class="token punctuation">.</span>forward<span class="token punctuation">;</span>
      position <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>position <span class="token operator">+</span> delta<span class="token punctuation">,</span> queue<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldTrigger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">triggerListeners</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>location<span class="token punctuation">,</span> from<span class="token punctuation">,</span> <span class="token punctuation">{</span>
          direction<span class="token punctuation">,</span>
          delta<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>routerHistory<span class="token punctuation">,</span> <span class="token string">&#39;location&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> queue<span class="token punctuation">[</span>position<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> routerHistory<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * Creates a hash history. Useful for web applications with no host (e.g.
 * `file://`) or when configuring a server to handle any URL is not possible.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">base</span> - optional base to provide. Defaults to `location.pathname +
 * location.search` If there is a `&lt;base&gt;` tag in the `head`, its value will be
 * ignored in favor of this parameter **but note it affects all the
 * history.pushState() calls**, meaning that if you use a `&lt;base&gt;` tag, it&#39;s
 * `href` value **has to match this parameter** (ignoring anything after the
 * `#`).
 *
 * <span class="token keyword">@example</span>
 <span class="token example">* <span class="token code language-javascript"><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>`js</span>
 * <span class="token code language-javascript"><span class="token comment">// at https://example.com/folder</span></span>
 * <span class="token code language-javascript"><span class="token function">createWebHashHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// gives a url of `https://example.com/folder#`</span></span>
 * <span class="token code language-javascript"><span class="token function">createWebHashHistory</span><span class="token punctuation">(</span><span class="token string">&#39;/folder/&#39;</span><span class="token punctuation">)</span> <span class="token comment">// gives a url of `https://example.com/folder/#`</span></span>
 * <span class="token code language-javascript"><span class="token comment">// if the `#` is provided in the base, it won&#39;t be added by `createWebHashHistory`</span></span>
 * <span class="token code language-javascript"><span class="token function">createWebHashHistory</span><span class="token punctuation">(</span><span class="token string">&#39;/folder/#/app/&#39;</span><span class="token punctuation">)</span> <span class="token comment">// gives a url of `https://example.com/folder/#/app/`</span></span>
 * <span class="token code language-javascript"><span class="token comment">// you should avoid doing this because it changes the original url and breaks copying urls</span></span>
 * <span class="token code language-javascript"><span class="token function">createWebHashHistory</span><span class="token punctuation">(</span><span class="token string">&#39;/other-folder/&#39;</span><span class="token punctuation">)</span> <span class="token comment">// gives a url of `https://example.com/other-folder/#`</span></span>
 *
 <span class="token code language-javascript"><span class="token operator">*</span> <span class="token comment">// at file:///usr/etc/folder/index.html</span></span>
 * <span class="token code language-javascript"><span class="token comment">// for locations with no `host`, the base is ignored</span></span>
 * <span class="token code language-javascript"><span class="token function">createWebHashHistory</span><span class="token punctuation">(</span><span class="token string">&#39;/iAmIgnored&#39;</span><span class="token punctuation">)</span> <span class="token comment">// gives a url of `file:///usr/etc/folder/index.html#`</span></span>
 * <span class="token code language-javascript"><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>`</span></span>
 */</span>
<span class="token keyword">function</span> <span class="token function">createWebHashHistory</span><span class="token punctuation">(</span><span class="token parameter">base</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Make sure this implementation is fine in terms of encoding, specially for IE11</span>
  <span class="token comment">// for `file://`, directly use the pathname and ignore the base</span>
  <span class="token comment">// location.pathname contains an initial `/` even at the root: `https://example.com`</span>
  base <span class="token operator">=</span> location<span class="token punctuation">.</span>host <span class="token operator">?</span> base <span class="token operator">||</span> location<span class="token punctuation">.</span>pathname <span class="token operator">+</span> location<span class="token punctuation">.</span>search <span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
  <span class="token comment">// allow the user to provide a `#` in the middle: `/base/#/app`</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>base<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;#&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> base <span class="token operator">+=</span> <span class="token string">&#39;#&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>base<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;#/&#39;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>base<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;#&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warn</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">A hash base must end with a &quot;#&quot;:\n&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>base<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; should be &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>base<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
        <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">#.*$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token string">&#39;#&#39;</span>
      <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">createWebHistory</span><span class="token punctuation">(</span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isRouteLocation</span><span class="token punctuation">(</span><span class="token parameter">route</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> route <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span> <span class="token punctuation">(</span>route <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> route <span class="token operator">===</span> <span class="token string">&#39;object&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">isRouteName</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">typeof</span> name <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> name <span class="token operator">===</span> <span class="token string">&#39;symbol&#39;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * Initial route location where the router is. Can be used in navigation guards
 * to differentiate the initial navigation.
 *
 * <span class="token keyword">@example</span>
 <span class="token example">* <span class="token code language-javascript"><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>`js</span>
 * <span class="token code language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">START_LOCATION</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;vue-router&#39;</span></span>
 *
 <span class="token code language-javascript"><span class="token operator">*</span> router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
 *   <span class="token code language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>from <span class="token operator">===</span> <span class="token constant">START_LOCATION</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
 *     <span class="token code language-javascript"><span class="token comment">// initial navigation</span></span>
 *   <span class="token code language-javascript"><span class="token punctuation">}</span></span>
 * <span class="token code language-javascript"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
 * <span class="token code language-javascript"><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token template-punctuation string">`</span></span>`</span></span>
 */</span>
<span class="token keyword">const</span> <span class="token constant">START_LOCATION_NORMALIZED</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  path<span class="token operator">:</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  params<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  query<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  hash<span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
  fullPath<span class="token operator">:</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span>
  matched<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  meta<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  redirectedFrom<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> NavigationFailureSymbol <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token function">PolySymbol</span><span class="token punctuation">(</span><span class="token string">&#39;navigation failure&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * Enumeration with all possible types for navigation failures. Can be passed to
 * <span class="token punctuation">{</span><span class="token keyword">@link</span> isNavigationFailure<span class="token punctuation">}</span> to check for specific failures.
 */</span>
<span class="token keyword">var</span> NavigationFailureType<span class="token punctuation">;</span>
<span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">NavigationFailureType</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token doc-comment comment">/**
   * An aborted navigation is a navigation that failed because a navigation
   * guard returned `false` or called `next(false)`
   */</span>
  NavigationFailureType<span class="token punctuation">[</span><span class="token punctuation">(</span>NavigationFailureType<span class="token punctuation">[</span><span class="token string">&#39;aborted&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;aborted&#39;</span><span class="token punctuation">;</span>
  <span class="token doc-comment comment">/**
   * A cancelled navigation is a navigation that failed because a more recent
   * navigation finished started (not necessarily finished).
   */</span>
  NavigationFailureType<span class="token punctuation">[</span><span class="token punctuation">(</span>NavigationFailureType<span class="token punctuation">[</span><span class="token string">&#39;cancelled&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&#39;cancelled&#39;</span><span class="token punctuation">;</span>
  <span class="token doc-comment comment">/**
   * A duplicated navigation is a navigation that failed because it was
   * initiated while already being at the exact same location.
   */</span>
  NavigationFailureType<span class="token punctuation">[</span><span class="token punctuation">(</span>NavigationFailureType<span class="token punctuation">[</span><span class="token string">&#39;duplicated&#39;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span>
    <span class="token string">&#39;duplicated&#39;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>NavigationFailureType <span class="token operator">||</span> <span class="token punctuation">(</span>NavigationFailureType <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// DEV only debug messages</span>
<span class="token keyword">const</span> ErrorTypeMessages <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">[</span><span class="token number">1</span> <span class="token comment">/* MATCHER_NOT_FOUND */</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> location<span class="token punctuation">,</span> currentLocation <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">No match for\n </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
      currentLocation
        <span class="token operator">?</span> <span class="token string">&#39;\nwhile being at\n&#39;</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>currentLocation<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token string">&#39;&#39;</span>
    <span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">2</span> <span class="token comment">/* NAVIGATION_GUARD_REDIRECT */</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> from<span class="token punctuation">,</span> to <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Redirected from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>from<span class="token punctuation">.</span>fullPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; to &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">stringifyRoute</span><span class="token punctuation">(</span>
      to
    <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; via a navigation guard.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">4</span> <span class="token comment">/* NAVIGATION_ABORTED */</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> from<span class="token punctuation">,</span> to <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Navigation aborted from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>from<span class="token punctuation">.</span>fullPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; to &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>to<span class="token punctuation">.</span>fullPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; via a navigation guard.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">8</span> <span class="token comment">/* NAVIGATION_CANCELLED */</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> from<span class="token punctuation">,</span> to <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Navigation cancelled from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>from<span class="token punctuation">.</span>fullPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; to &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>to<span class="token punctuation">.</span>fullPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; with a new navigation.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token number">16</span> <span class="token comment">/* NAVIGATION_DUPLICATED */</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> from<span class="token punctuation">,</span> to <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Avoided redundant navigation to current location: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>from<span class="token punctuation">.</span>fullPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">createRouterError</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// keep full error messages in cjs versions</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">assign</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>ErrorTypeMessages<span class="token punctuation">[</span>type<span class="token punctuation">]</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        type<span class="token punctuation">,</span>
        <span class="token punctuation">[</span>NavigationFailureSymbol<span class="token punctuation">]</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      params
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">isNavigationFailure</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    error <span class="token keyword">instanceof</span> <span class="token class-name">Error</span> <span class="token operator">&amp;&amp;</span>
    NavigationFailureSymbol <span class="token keyword">in</span> error <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>type <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span>type <span class="token operator">&amp;</span> type<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> propertiesToLog <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;params&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;query&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;hash&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">stringifyRoute</span><span class="token punctuation">(</span><span class="token parameter">to</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> to<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span> <span class="token keyword">in</span> to<span class="token punctuation">)</span> <span class="token keyword">return</span> to<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
  <span class="token keyword">const</span> location <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> propertiesToLog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> to<span class="token punctuation">)</span> location<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> to<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// default pattern for a param: non greedy everything but /</span>
<span class="token keyword">const</span> <span class="token constant">BASE_PARAM_PATTERN</span> <span class="token operator">=</span> <span class="token string">&#39;[^/]+?&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">BASE_PATH_PARSER_OPTIONS</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  sensitive<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  strict<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  start<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  end<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// Special Regex characters that must be escaped in static tokens</span>
<span class="token keyword">const</span> <span class="token constant">REGEX_CHARS_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[.+*?^${}()[\]/\\]</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span>
<span class="token doc-comment comment">/**
 * Creates a path parser from an array of Segments (a segment is an array of Tokens)
 *
 * <span class="token keyword">@param</span> <span class="token parameter">segments</span> - array of segments returned by tokenizePath
 * <span class="token keyword">@param</span> <span class="token parameter">extraOptions</span> - optional options for the regexp
 * <span class="token keyword">@returns</span> a PathParser
 */</span>
<span class="token keyword">function</span> <span class="token function">tokensToParser</span><span class="token punctuation">(</span><span class="token parameter">segments<span class="token punctuation">,</span> extraOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">BASE_PATH_PARSER_OPTIONS</span><span class="token punctuation">,</span> extraOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// the amount of scores is the same as the length of segments except for the root segment &quot;/&quot;</span>
  <span class="token keyword">const</span> score <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// the regexp as a string</span>
  <span class="token keyword">let</span> pattern <span class="token operator">=</span> options<span class="token punctuation">.</span>start <span class="token operator">?</span> <span class="token string">&#39;^&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
  <span class="token comment">// extracted keys</span>
  <span class="token keyword">const</span> keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> segment <span class="token keyword">of</span> segments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// the root segment needs special treatment</span>
    <span class="token keyword">const</span> segmentScores <span class="token operator">=</span> segment<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">90</span> <span class="token comment">/* Root */</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// allow trailing slash</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>strict <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>segment<span class="token punctuation">.</span>length<span class="token punctuation">)</span> pattern <span class="token operator">+=</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> tokenIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> tokenIndex <span class="token operator">&lt;</span> segment<span class="token punctuation">.</span>length<span class="token punctuation">;</span> tokenIndex<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> token <span class="token operator">=</span> segment<span class="token punctuation">[</span>tokenIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// resets the score if we are inside a sub segment /:a-other-:b</span>
      <span class="token keyword">let</span> subSegmentScore <span class="token operator">=</span>
        <span class="token number">40</span> <span class="token comment">/* Segment */</span> <span class="token operator">+</span>
        <span class="token punctuation">(</span>options<span class="token punctuation">.</span>sensitive <span class="token operator">?</span> <span class="token number">0.25</span> <span class="token comment">/* BonusCaseSensitive */</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">0</span> <span class="token comment">/* Static */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// prepend the slash if we are starting a new segment</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tokenIndex<span class="token punctuation">)</span> pattern <span class="token operator">+=</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">;</span>
        pattern <span class="token operator">+=</span> token<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">REGEX_CHARS_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;\\<!--vuepress-ssr-app-->amp;&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        subSegmentScore <span class="token operator">+=</span> <span class="token number">40</span> <span class="token comment">/* Static */</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span> <span class="token comment">/* Param */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> repeatable<span class="token punctuation">,</span> optional<span class="token punctuation">,</span> regexp <span class="token punctuation">}</span> <span class="token operator">=</span> token<span class="token punctuation">;</span>
        keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          name<span class="token operator">:</span> value<span class="token punctuation">,</span>
          repeatable<span class="token punctuation">,</span>
          optional<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> re <span class="token operator">=</span> regexp <span class="token operator">?</span> regexp <span class="token operator">:</span> <span class="token constant">BASE_PARAM_PATTERN</span><span class="token punctuation">;</span>
        <span class="token comment">// the user provided a custom regexp /:id(\\d+)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>re <span class="token operator">!==</span> <span class="token constant">BASE_PARAM_PATTERN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          subSegmentScore <span class="token operator">+=</span> <span class="token number">10</span> <span class="token comment">/* BonusCustomRegExp */</span><span class="token punctuation">;</span>
          <span class="token comment">// make sure the regexp is valid before using it</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>re<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid custom RegExp for param &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>re<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">): </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
                err<span class="token punctuation">.</span>message
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// when we repeat we must take care of the repeating leading slash</span>
        <span class="token keyword">let</span> subPattern <span class="token operator">=</span> repeatable <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">((?:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>re<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)(?:/(?:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>re<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">))*)</span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>re<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
        <span class="token comment">// prepend the slash if we are starting a new segment</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tokenIndex<span class="token punctuation">)</span>
          subPattern <span class="token operator">=</span>
            <span class="token comment">// avoid an optional / if there are more segments e.g. /:p?-static</span>
            <span class="token comment">// or /:p?-:p2</span>
            optional <span class="token operator">&amp;&amp;</span> segment<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">2</span>
              <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(?:/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>subPattern<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)</span><span class="token template-punctuation string">`</span></span>
              <span class="token operator">:</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">+</span> subPattern<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>optional<span class="token punctuation">)</span> subPattern <span class="token operator">+=</span> <span class="token string">&#39;?&#39;</span><span class="token punctuation">;</span>
        pattern <span class="token operator">+=</span> subPattern<span class="token punctuation">;</span>
        subSegmentScore <span class="token operator">+=</span> <span class="token number">20</span> <span class="token comment">/* Dynamic */</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>optional<span class="token punctuation">)</span> subSegmentScore <span class="token operator">+=</span> <span class="token operator">-</span><span class="token number">8</span> <span class="token comment">/* BonusOptional */</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>repeatable<span class="token punctuation">)</span> subSegmentScore <span class="token operator">+=</span> <span class="token operator">-</span><span class="token number">20</span> <span class="token comment">/* BonusRepeatable */</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>re <span class="token operator">===</span> <span class="token string">&#39;.*&#39;</span><span class="token punctuation">)</span> subSegmentScore <span class="token operator">+=</span> <span class="token operator">-</span><span class="token number">50</span> <span class="token comment">/* BonusWildcard */</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      segmentScores<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>subSegmentScore<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// an empty array like /home/ -&gt; [[{home}], []]</span>
    <span class="token comment">// if (!segment.length) pattern += &#39;/&#39;</span>
    score<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>segmentScores<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// only apply the strict bonus to the last score</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>strict <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> i <span class="token operator">=</span> score<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    score<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>score<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">0.7000000000000001</span> <span class="token comment">/* BonusStrict */</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// TODO: dev only warn double trailing slash</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>strict<span class="token punctuation">)</span> pattern <span class="token operator">+=</span> <span class="token string">&#39;/?&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>end<span class="token punctuation">)</span> pattern <span class="token operator">+=</span> <span class="token string">&#39;<!--vuepress-ssr-app-->#39;</span><span class="token punctuation">;</span>
  <span class="token comment">// allow paths like /dynamic to only match dynamic or dynamic/... but not dynamic_something_else</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>strict<span class="token punctuation">)</span> pattern <span class="token operator">+=</span> <span class="token string">&#39;(?:/|$)&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> re <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> options<span class="token punctuation">.</span>sensitive <span class="token operator">?</span> <span class="token string">&#39;&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;i&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">parse</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> match <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>re<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>match<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> match<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> value <span class="token operator">=</span> match<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      params<span class="token punctuation">[</span>key<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> value <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span>repeatable <span class="token operator">?</span> value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token operator">:</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> params<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">stringify</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
    <span class="token comment">// for optional parameters to allow to be empty</span>
    <span class="token keyword">let</span> avoidDuplicatedSlash <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> segment <span class="token keyword">of</span> segments<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>avoidDuplicatedSlash <span class="token operator">||</span> <span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> path <span class="token operator">+=</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">;</span>
      avoidDuplicatedSlash <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> token <span class="token keyword">of</span> segment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">0</span> <span class="token comment">/* Static */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          path <span class="token operator">+=</span> token<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token number">1</span> <span class="token comment">/* Param */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> <span class="token punctuation">{</span> value<span class="token punctuation">,</span> repeatable<span class="token punctuation">,</span> optional <span class="token punctuation">}</span> <span class="token operator">=</span> token<span class="token punctuation">;</span>
          <span class="token keyword">const</span> param <span class="token operator">=</span> value <span class="token keyword">in</span> params <span class="token operator">?</span> params<span class="token punctuation">[</span>value<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>repeatable<span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Provided param &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is an array but it is not repeatable (* or + modifiers)</span><span class="token template-punctuation string">`</span></span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> text <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span> <span class="token operator">?</span> param<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token operator">:</span> param<span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>optional<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// if we have more than one optional param like /:a?-static we</span>
              <span class="token comment">// don&#39;t need to care about the optional param</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>segment<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// remove the last slash as we could be at the end</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> path <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// do not append a slash on the next iteration</span>
                <span class="token keyword">else</span> avoidDuplicatedSlash <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Missing required param &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          path <span class="token operator">+=</span> text<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> path<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    re<span class="token punctuation">,</span>
    score<span class="token punctuation">,</span>
    keys<span class="token punctuation">,</span>
    parse<span class="token punctuation">,</span>
    stringify<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Compares an array of numbers as used in PathParser.score and returns a
 * number. This function can be used to `sort` an array
 *
 * <span class="token keyword">@param</span> <span class="token parameter">a</span> - first array of numbers
 * <span class="token keyword">@param</span> <span class="token parameter">b</span> - second array of numbers
 * <span class="token keyword">@returns</span> 0 if both are equal, &lt; 0 if a should be sorted first, &gt; 0 if b
 * should be sorted first
 */</span>
<span class="token keyword">function</span> <span class="token function">compareScoreArray</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> a<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> diff <span class="token operator">=</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// only keep going if diff === 0</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>diff<span class="token punctuation">)</span> <span class="token keyword">return</span> diff<span class="token punctuation">;</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// if the last subsegment was Static, the shorter segments should be sorted first</span>
  <span class="token comment">// otherwise sort the longest segment first</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> a<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">40</span> <span class="token comment">/* Static */</span> <span class="token operator">+</span> <span class="token number">40</span> <span class="token comment">/* Segment */</span>
      <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span>
      <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>a<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> b<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> b<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">40</span> <span class="token comment">/* Static */</span> <span class="token operator">+</span> <span class="token number">40</span> <span class="token comment">/* Segment */</span>
      <span class="token operator">?</span> <span class="token number">1</span>
      <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Compare function that can be used with `sort` to sort an array of PathParser
 *
 * <span class="token keyword">@param</span> <span class="token parameter">a</span> - first PathParser
 * <span class="token keyword">@param</span> <span class="token parameter">b</span> - second PathParser
 * <span class="token keyword">@returns</span> 0 if both are equal, &lt; 0 if a should be sorted first, &gt; 0 if b
 */</span>
<span class="token keyword">function</span> <span class="token function">comparePathParserScore</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> aScore <span class="token operator">=</span> a<span class="token punctuation">.</span>score<span class="token punctuation">;</span>
  <span class="token keyword">const</span> bScore <span class="token operator">=</span> b<span class="token punctuation">.</span>score<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> aScore<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> bScore<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> comp <span class="token operator">=</span> <span class="token function">compareScoreArray</span><span class="token punctuation">(</span>aScore<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> bScore<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// do not return if both are equal</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>comp<span class="token punctuation">)</span> <span class="token keyword">return</span> comp<span class="token punctuation">;</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// if a and b share the same score entries but b has more, sort b first</span>
  <span class="token keyword">return</span> bScore<span class="token punctuation">.</span>length <span class="token operator">-</span> aScore<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token comment">// this is the ternary version</span>
  <span class="token comment">// return aScore.length &lt; bScore.length</span>
  <span class="token comment">//   ? 1</span>
  <span class="token comment">//   : aScore.length &gt; bScore.length</span>
  <span class="token comment">//   ? -1</span>
  <span class="token comment">//   : 0</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token constant">ROOT_TOKEN</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token number">0</span> <span class="token comment">/* Static */</span><span class="token punctuation">,</span>
  value<span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">VALID_PARAM_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[a-zA-Z0-9_]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span>
<span class="token comment">// After some profiling, the cache seems to be unnecessary because tokenizePath</span>
<span class="token comment">// (the slowest part of adding a route) is very fast</span>
<span class="token comment">// const tokenCache = new Map&lt;string, Token[][]&gt;()</span>
<span class="token keyword">function</span> <span class="token function">tokenizePath</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>path<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>path <span class="token operator">===</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token constant">ROOT_TOKEN</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Route paths should start with a &quot;/&quot;: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; should be &quot;/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// if (tokenCache.has(path)) return tokenCache.get(path)!</span>
  <span class="token keyword">function</span> <span class="token function">crash</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ERR (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)/&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buffer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* Static */</span>
  <span class="token keyword">let</span> previousState <span class="token operator">=</span> state<span class="token punctuation">;</span>
  <span class="token keyword">const</span> tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// the segment will always be valid because we get into the initial state</span>
  <span class="token comment">// with the leading /</span>
  <span class="token keyword">let</span> segment<span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">finalizeSegment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>segment<span class="token punctuation">)</span> tokens<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>segment<span class="token punctuation">)</span><span class="token punctuation">;</span>
    segment <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// index on the path</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// char at index</span>
  <span class="token keyword">let</span> char<span class="token punctuation">;</span>
  <span class="token comment">// buffer of the value read</span>
  <span class="token keyword">let</span> buffer <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
  <span class="token comment">// custom regexp for a param</span>
  <span class="token keyword">let</span> customRe <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">consumeBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>buffer<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> <span class="token number">0</span> <span class="token comment">/* Static */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      segment<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token number">0</span> <span class="token comment">/* Static */</span><span class="token punctuation">,</span>
        value<span class="token operator">:</span> buffer<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
      state <span class="token operator">===</span> <span class="token number">1</span> <span class="token comment">/* Param */</span> <span class="token operator">||</span>
      state <span class="token operator">===</span> <span class="token number">2</span> <span class="token comment">/* ParamRegExp */</span> <span class="token operator">||</span>
      state <span class="token operator">===</span> <span class="token number">3</span> <span class="token comment">/* ParamRegExpEnd */</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>segment<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">&#39;*&#39;</span> <span class="token operator">||</span> char <span class="token operator">===</span> <span class="token string">&#39;+&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">crash</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">A repeatable param (</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buffer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">) must be alone in its segment. eg: &#39;/:ids+.</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      segment<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token number">1</span> <span class="token comment">/* Param */</span><span class="token punctuation">,</span>
        value<span class="token operator">:</span> buffer<span class="token punctuation">,</span>
        regexp<span class="token operator">:</span> customRe<span class="token punctuation">,</span>
        repeatable<span class="token operator">:</span> char <span class="token operator">===</span> <span class="token string">&#39;*&#39;</span> <span class="token operator">||</span> char <span class="token operator">===</span> <span class="token string">&#39;+&#39;</span><span class="token punctuation">,</span>
        optional<span class="token operator">:</span> char <span class="token operator">===</span> <span class="token string">&#39;*&#39;</span> <span class="token operator">||</span> char <span class="token operator">===</span> <span class="token string">&#39;?&#39;</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">crash</span><span class="token punctuation">(</span><span class="token string">&#39;Invalid state to consume buffer&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    buffer <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">addCharToBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    buffer <span class="token operator">+=</span> char<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> path<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    char <span class="token operator">=</span> path<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">&#39;\\&#39;</span> <span class="token operator">&amp;&amp;</span> state <span class="token operator">!==</span> <span class="token number">2</span> <span class="token comment">/* ParamRegExp */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      previousState <span class="token operator">=</span> state<span class="token punctuation">;</span>
      state <span class="token operator">=</span> <span class="token number">4</span> <span class="token comment">/* EscapeNext */</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token number">0</span> <span class="token comment">/* Static */</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">consumeBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token function">finalizeSegment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">&#39;:&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">consumeBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          state <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">/* Param */</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">addCharToBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">4</span> <span class="token comment">/* EscapeNext */</span><span class="token operator">:</span>
        <span class="token function">addCharToBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        state <span class="token operator">=</span> previousState<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">1</span> <span class="token comment">/* Param */</span><span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">&#39;(&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          state <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">/* ParamRegExp */</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">VALID_PARAM_RE</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>char<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">addCharToBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">consumeBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          state <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">/* Static */</span><span class="token punctuation">;</span>
          <span class="token comment">// go back one character if we were not modifying</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">!==</span> <span class="token string">&#39;*&#39;</span> <span class="token operator">&amp;&amp;</span> char <span class="token operator">!==</span> <span class="token string">&#39;?&#39;</span> <span class="token operator">&amp;&amp;</span> char <span class="token operator">!==</span> <span class="token string">&#39;+&#39;</span><span class="token punctuation">)</span> i<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">2</span> <span class="token comment">/* ParamRegExp */</span><span class="token operator">:</span>
        <span class="token comment">// TODO: is it worth handling nested regexp? like :p(?:prefix_([^/]+)_suffix)</span>
        <span class="token comment">// it already works by escaping the closing )</span>
        <span class="token comment">// https://paths.esm.dev/?p=AAMeJbiAwQEcDKbAoAAkP60PG2R6QAvgNaA6AFACM2ABuQBB#</span>
        <span class="token comment">// is this really something people need since you can also write</span>
        <span class="token comment">// /prefix_:p()_suffix</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">===</span> <span class="token string">&#39;)&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// handle the escaped )</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>customRe<span class="token punctuation">[</span>customRe<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&#39;\\&#39;</span><span class="token punctuation">)</span>
            customRe <span class="token operator">=</span> customRe<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> char<span class="token punctuation">;</span>
          <span class="token keyword">else</span> state <span class="token operator">=</span> <span class="token number">3</span> <span class="token comment">/* ParamRegExpEnd */</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          customRe <span class="token operator">+=</span> char<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">3</span> <span class="token comment">/* ParamRegExpEnd */</span><span class="token operator">:</span>
        <span class="token comment">// same as finalizing a param</span>
        <span class="token function">consumeBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        state <span class="token operator">=</span> <span class="token number">0</span> <span class="token comment">/* Static */</span><span class="token punctuation">;</span>
        <span class="token comment">// go back one character if we were not modifying</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>char <span class="token operator">!==</span> <span class="token string">&#39;*&#39;</span> <span class="token operator">&amp;&amp;</span> char <span class="token operator">!==</span> <span class="token string">&#39;?&#39;</span> <span class="token operator">&amp;&amp;</span> char <span class="token operator">!==</span> <span class="token string">&#39;+&#39;</span><span class="token punctuation">)</span> i<span class="token operator">--</span><span class="token punctuation">;</span>
        customRe <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token function">crash</span><span class="token punctuation">(</span><span class="token string">&#39;Unknown state&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">===</span> <span class="token number">2</span> <span class="token comment">/* ParamRegExp */</span><span class="token punctuation">)</span>
    <span class="token function">crash</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Unfinished custom RegExp for param &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>buffer<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">consumeBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">finalizeSegment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// tokenCache.set(path, tokens)</span>
  <span class="token keyword">return</span> tokens<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">createRouteRecordMatcher</span><span class="token punctuation">(</span><span class="token parameter">record<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">tokensToParser</span><span class="token punctuation">(</span><span class="token function">tokenizePath</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// warn against params with the same name</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">const</span> existingKeys <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> parser<span class="token punctuation">.</span>keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>existingKeys<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Found duplicated params with name &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; for path &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>record<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. Only the last one will be available on &quot;$route.params&quot;.</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      existingKeys<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> matcher <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    record<span class="token punctuation">,</span>
    parent<span class="token punctuation">,</span>
    <span class="token comment">// these needs to be populated by the parent</span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    alias<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// both are aliases or both are not aliases</span>
    <span class="token comment">// we don&#39;t want to mix them because the order is used when</span>
    <span class="token comment">// passing originalRecord in Matcher.addRoute</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matcher<span class="token punctuation">.</span>record<span class="token punctuation">.</span>aliasOf <span class="token operator">===</span> <span class="token operator">!</span>parent<span class="token punctuation">.</span>record<span class="token punctuation">.</span>aliasOf<span class="token punctuation">)</span>
      parent<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> matcher<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * Creates a Router Matcher.
 *
 * <span class="token keyword">@internal</span>
 * <span class="token keyword">@param</span> <span class="token parameter">routes</span> - array of initial routes
 * <span class="token keyword">@param</span> <span class="token parameter">globalOptions</span> - global route options
 */</span>
<span class="token keyword">function</span> <span class="token function">createRouterMatcher</span><span class="token punctuation">(</span><span class="token parameter">routes<span class="token punctuation">,</span> globalOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// normalized ordered array of matchers</span>
  <span class="token keyword">const</span> matchers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> matcherMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  globalOptions <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span> strict<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> end<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> sensitive<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    globalOptions
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">function</span> <span class="token function">getRecordMatcher</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> matcherMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">addRoute</span><span class="token punctuation">(</span><span class="token parameter">record<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> originalRecord</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// used later on to remove by name</span>
    <span class="token keyword">const</span> isRootAdd <span class="token operator">=</span> <span class="token operator">!</span>originalRecord<span class="token punctuation">;</span>
    <span class="token keyword">const</span> mainNormalizedRecord <span class="token operator">=</span> <span class="token function">normalizeRouteRecord</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// we might be the child of an alias</span>
    mainNormalizedRecord<span class="token punctuation">.</span>aliasOf <span class="token operator">=</span> originalRecord <span class="token operator">&amp;&amp;</span> originalRecord<span class="token punctuation">.</span>record<span class="token punctuation">;</span>
    <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span>globalOptions<span class="token punctuation">,</span> record<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// generate an array of records to correctly handle aliases</span>
    <span class="token keyword">const</span> normalizedRecords <span class="token operator">=</span> <span class="token punctuation">[</span>mainNormalizedRecord<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&#39;alias&#39;</span> <span class="token keyword">in</span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> aliases <span class="token operator">=</span>
        <span class="token keyword">typeof</span> record<span class="token punctuation">.</span>alias <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span> <span class="token operator">?</span> <span class="token punctuation">[</span>record<span class="token punctuation">.</span>alias<span class="token punctuation">]</span> <span class="token operator">:</span> record<span class="token punctuation">.</span>alias<span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> alias <span class="token keyword">of</span> aliases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        normalizedRecords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
          <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> mainNormalizedRecord<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token comment">// this allows us to hold a copy of the `components` option</span>
            <span class="token comment">// so that async components cache is hold on the original record</span>
            components<span class="token operator">:</span> originalRecord
              <span class="token operator">?</span> originalRecord<span class="token punctuation">.</span>record<span class="token punctuation">.</span>components
              <span class="token operator">:</span> mainNormalizedRecord<span class="token punctuation">.</span>components<span class="token punctuation">,</span>
            path<span class="token operator">:</span> alias<span class="token punctuation">,</span>
            <span class="token comment">// we might be the child of an alias</span>
            aliasOf<span class="token operator">:</span> originalRecord
              <span class="token operator">?</span> originalRecord<span class="token punctuation">.</span>record
              <span class="token operator">:</span> mainNormalizedRecord<span class="token punctuation">,</span>
            <span class="token comment">// the aliases are always of the same kind as the original since they</span>
            <span class="token comment">// are defined on the same record</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> matcher<span class="token punctuation">;</span>
    <span class="token keyword">let</span> originalMatcher<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> normalizedRecord <span class="token keyword">of</span> normalizedRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> path <span class="token punctuation">}</span> <span class="token operator">=</span> normalizedRecord<span class="token punctuation">;</span>
      <span class="token comment">// Build up the path for nested routes if the child isn&#39;t an absolute</span>
      <span class="token comment">// route. Only add the / delimiter if the child path isn&#39;t empty and if the</span>
      <span class="token comment">// parent path doesn&#39;t have a trailing slash</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> parentPath <span class="token operator">=</span> parent<span class="token punctuation">.</span>record<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
        <span class="token keyword">const</span> connectingSlash <span class="token operator">=</span>
          parentPath<span class="token punctuation">[</span>parentPath<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">?</span> <span class="token string">&#39;&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">;</span>
        normalizedRecord<span class="token punctuation">.</span>path <span class="token operator">=</span>
          parent<span class="token punctuation">.</span>record<span class="token punctuation">.</span>path <span class="token operator">+</span> <span class="token punctuation">(</span>path <span class="token operator">&amp;&amp;</span> connectingSlash <span class="token operator">+</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>normalizedRecord<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">&#39;*&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
          <span class="token string">&#39;Catch all routes (&quot;*&quot;) must now be defined using a param with a custom regexp.\n&#39;</span> <span class="token operator">+</span>
            <span class="token string">&#39;See more at https://next.router.vuejs.org/guide/migration/#removed-star-or-catch-all-routes.&#39;</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// create the object before hand so it can be passed to children</span>
      matcher <span class="token operator">=</span> <span class="token function">createRouteRecordMatcher</span><span class="token punctuation">(</span>normalizedRecord<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">&amp;&amp;</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span>
        <span class="token function">checkMissingParamsInAbsolutePath</span><span class="token punctuation">(</span>matcher<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// if we are an alias we must tell the original record that we exist</span>
      <span class="token comment">// so we can be removed</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>originalRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        originalRecord<span class="token punctuation">.</span>alias<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">{</span>
          <span class="token function">checkSameParams</span><span class="token punctuation">(</span>originalRecord<span class="token punctuation">,</span> matcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// otherwise, the first record is the original and others are aliases</span>
        originalMatcher <span class="token operator">=</span> originalMatcher <span class="token operator">||</span> matcher<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>originalMatcher <span class="token operator">!==</span> matcher<span class="token punctuation">)</span> originalMatcher<span class="token punctuation">.</span>alias<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// remove the route if named and only for the top record (avoid in nested calls)</span>
        <span class="token comment">// this works because the original record is the first one</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isRootAdd <span class="token operator">&amp;&amp;</span> record<span class="token punctuation">.</span>name <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isAliasRecord</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token function">removeRoute</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&#39;children&#39;</span> <span class="token keyword">in</span> mainNormalizedRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> children <span class="token operator">=</span> mainNormalizedRecord<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">addRoute</span><span class="token punctuation">(</span>
            children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
            matcher<span class="token punctuation">,</span>
            originalRecord <span class="token operator">&amp;&amp;</span> originalRecord<span class="token punctuation">.</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// if there was no original record, then the first one was not an alias and all</span>
      <span class="token comment">// other alias (if any) need to reference this record when adding children</span>
      originalRecord <span class="token operator">=</span> originalRecord <span class="token operator">||</span> matcher<span class="token punctuation">;</span>
      <span class="token comment">// TODO: add normalized records for more flexibility</span>
      <span class="token comment">// if (parent &amp;&amp; isAliasRecord(originalRecord)) {</span>
      <span class="token comment">//   parent.children.push(originalRecord)</span>
      <span class="token comment">// }</span>
      <span class="token function">insertMatcher</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> originalMatcher
      <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// since other matchers are aliases, they should be removed by the original matcher</span>
          <span class="token function">removeRoute</span><span class="token punctuation">(</span>originalMatcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token operator">:</span> noop<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">removeRoute</span><span class="token punctuation">(</span><span class="token parameter">matcherRef</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRouteName</span><span class="token punctuation">(</span>matcherRef<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> matcher <span class="token operator">=</span> matcherMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>matcherRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>matcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        matcherMap<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>matcherRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
        matchers<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>matchers<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        matcher<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>removeRoute<span class="token punctuation">)</span><span class="token punctuation">;</span>
        matcher<span class="token punctuation">.</span>alias<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>removeRoute<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> index <span class="token operator">=</span> matchers<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>matcherRef<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        matchers<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>matcherRef<span class="token punctuation">.</span>record<span class="token punctuation">.</span>name<span class="token punctuation">)</span> matcherMap<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>matcherRef<span class="token punctuation">.</span>record<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        matcherRef<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>removeRoute<span class="token punctuation">)</span><span class="token punctuation">;</span>
        matcherRef<span class="token punctuation">.</span>alias<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>removeRoute<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">getRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> matchers<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">insertMatcher</span><span class="token punctuation">(</span><span class="token parameter">matcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// console.log(&#39;i is&#39;, { i })</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>
      i <span class="token operator">&lt;</span> matchers<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span>
      <span class="token function">comparePathParserScore</span><span class="token punctuation">(</span>matcher<span class="token punctuation">,</span> matchers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span>
    <span class="token punctuation">)</span>
      i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token comment">// console.log(&#39;END i is&#39;, { i })</span>
    <span class="token comment">// while (i &lt; matchers.length &amp;&amp; matcher.score &lt;= matchers[i].score) i++</span>
    matchers<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> matcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// only add the original record to the name map</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>matcher<span class="token punctuation">.</span>record<span class="token punctuation">.</span>name <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isAliasRecord</span><span class="token punctuation">(</span>matcher<span class="token punctuation">)</span><span class="token punctuation">)</span>
      matcherMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>matcher<span class="token punctuation">.</span>record<span class="token punctuation">.</span>name<span class="token punctuation">,</span> matcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">location<span class="token punctuation">,</span> currentLocation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> matcher<span class="token punctuation">;</span>
    <span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> path<span class="token punctuation">;</span>
    <span class="token keyword">let</span> name<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span> <span class="token keyword">in</span> location <span class="token operator">&amp;&amp;</span> location<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      matcher <span class="token operator">=</span> matcherMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matcher<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token function">createRouterError</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token comment">/* MATCHER_NOT_FOUND */</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          location<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      name <span class="token operator">=</span> matcher<span class="token punctuation">.</span>record<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      params <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span>
        <span class="token comment">// paramsFromLocation is a new object</span>
        <span class="token function">paramsFromLocation</span><span class="token punctuation">(</span>
          currentLocation<span class="token punctuation">.</span>params<span class="token punctuation">,</span>
          <span class="token comment">// only keep params that exist in the resolved location</span>
          <span class="token comment">// TODO: only keep optional params coming from a parent record</span>
          matcher<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>k<span class="token punctuation">.</span>optional<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">k</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> k<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        location<span class="token punctuation">.</span>params
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// throws if cannot be stringified</span>
      path <span class="token operator">=</span> matcher<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span> <span class="token keyword">in</span> location<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// no need to resolve the path with the matcher as it was provided</span>
      <span class="token comment">// this also allows the user to control the encoding</span>
      path <span class="token operator">=</span> location<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>path<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The Matcher cannot resolve relative paths but received &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. Unless you directly called \`matcher.resolve(&quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;)\`, this is probably a bug in vue-router. Please open an issue at https://new-issue.vuejs.org/?repo=vuejs/vue-router-next.</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      matcher <span class="token operator">=</span> matchers<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>re<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// matcher should have a value after the loop</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>matcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// TODO: dev warning of unused params if provided</span>
        <span class="token comment">// we know the matcher works because we tested the regexp</span>
        params <span class="token operator">=</span> matcher<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        name <span class="token operator">=</span> matcher<span class="token punctuation">.</span>record<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// location is a relative path</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// match by name or path of current route</span>
      matcher <span class="token operator">=</span> currentLocation<span class="token punctuation">.</span>name
        <span class="token operator">?</span> matcherMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentLocation<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token operator">:</span> matchers<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">m</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span>re<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>currentLocation<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matcher<span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token function">createRouterError</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token comment">/* MATCHER_NOT_FOUND */</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          location<span class="token punctuation">,</span>
          currentLocation<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      name <span class="token operator">=</span> matcher<span class="token punctuation">.</span>record<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      <span class="token comment">// since we are navigating to the same location, we don&#39;t need to pick the</span>
      <span class="token comment">// params like when `name` is provided</span>
      params <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> currentLocation<span class="token punctuation">.</span>params<span class="token punctuation">,</span> location<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
      path <span class="token operator">=</span> matcher<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> matched <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> parentMatcher <span class="token operator">=</span> matcher<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>parentMatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// reversed order so parents are at the beginning</span>
      matched<span class="token punctuation">.</span><span class="token function">unshift</span><span class="token punctuation">(</span>parentMatcher<span class="token punctuation">.</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
      parentMatcher <span class="token operator">=</span> parentMatcher<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      name<span class="token punctuation">,</span>
      path<span class="token punctuation">,</span>
      params<span class="token punctuation">,</span>
      matched<span class="token punctuation">,</span>
      meta<span class="token operator">:</span> <span class="token function">mergeMetaFields</span><span class="token punctuation">(</span>matched<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// add initial routes</span>
  routes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">route</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">addRoute</span><span class="token punctuation">(</span>route<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span> addRoute<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> removeRoute<span class="token punctuation">,</span> getRoutes<span class="token punctuation">,</span> getRecordMatcher <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">paramsFromLocation</span><span class="token punctuation">(</span><span class="token parameter">params<span class="token punctuation">,</span> keys</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newParams <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> params<span class="token punctuation">)</span> newParams<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> newParams<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Normalizes a RouteRecordRaw. Creates a copy
 *
 * <span class="token keyword">@param</span> <span class="token parameter">record</span>
 * <span class="token keyword">@returns</span> the normalized version
 */</span>
<span class="token keyword">function</span> <span class="token function">normalizeRouteRecord</span><span class="token punctuation">(</span><span class="token parameter">record</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> record<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
    redirect<span class="token operator">:</span> record<span class="token punctuation">.</span>redirect<span class="token punctuation">,</span>
    name<span class="token operator">:</span> record<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    meta<span class="token operator">:</span> record<span class="token punctuation">.</span>meta <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    aliasOf<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    beforeEnter<span class="token operator">:</span> record<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">,</span>
    props<span class="token operator">:</span> <span class="token function">normalizeRecordProps</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> record<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    instances<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    leaveGuards<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    updateGuards<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    enterCallbacks<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    components<span class="token operator">:</span>
      <span class="token string">&#39;components&#39;</span> <span class="token keyword">in</span> record
        <span class="token operator">?</span> record<span class="token punctuation">.</span>components <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token operator">:</span> record<span class="token punctuation">.</span>component <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Normalize the optional `props` in a record to always be an object similar to
 * components. Also accept a boolean for components.
 * <span class="token keyword">@param</span> <span class="token parameter">record</span>
 */</span>
<span class="token keyword">function</span> <span class="token function">normalizeRecordProps</span><span class="token punctuation">(</span><span class="token parameter">record</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> propsObject <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// props does not exist on redirect records but we can set false directly</span>
  <span class="token keyword">const</span> props <span class="token operator">=</span> record<span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&#39;component&#39;</span> <span class="token keyword">in</span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    propsObject<span class="token punctuation">.</span>default <span class="token operator">=</span> props<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// NOTE: we could also allow a function to be applied to every component.</span>
    <span class="token comment">// Would need user feedback for use cases</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> name <span class="token keyword">in</span> record<span class="token punctuation">.</span>components<span class="token punctuation">)</span>
      propsObject<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">typeof</span> props <span class="token operator">===</span> <span class="token string">&#39;boolean&#39;</span> <span class="token operator">?</span> props <span class="token operator">:</span> props<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> propsObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Checks if a record or any of its parent is an alias
 * <span class="token keyword">@param</span> <span class="token parameter">record</span>
 */</span>
<span class="token keyword">function</span> <span class="token function">isAliasRecord</span><span class="token punctuation">(</span><span class="token parameter">record</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>record<span class="token punctuation">.</span>aliasOf<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    record <span class="token operator">=</span> record<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Merge meta fields of an array of records
 *
 * <span class="token keyword">@param</span> <span class="token parameter">matched</span> - array of matched records
 */</span>
<span class="token keyword">function</span> <span class="token function">mergeMetaFields</span><span class="token punctuation">(</span><span class="token parameter">matched</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> matched<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">meta<span class="token punctuation">,</span> record</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">assign</span><span class="token punctuation">(</span>meta<span class="token punctuation">,</span> record<span class="token punctuation">.</span>meta<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">mergeOptions</span><span class="token punctuation">(</span><span class="token parameter">defaults<span class="token punctuation">,</span> partialOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> defaults<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> key <span class="token keyword">in</span> partialOptions <span class="token operator">?</span> partialOptions<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">:</span> defaults<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> options<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">isSameParam</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    a<span class="token punctuation">.</span>name <span class="token operator">===</span> b<span class="token punctuation">.</span>name <span class="token operator">&amp;&amp;</span>
    a<span class="token punctuation">.</span>optional <span class="token operator">===</span> b<span class="token punctuation">.</span>optional <span class="token operator">&amp;&amp;</span>
    a<span class="token punctuation">.</span>repeatable <span class="token operator">===</span> b<span class="token punctuation">.</span>repeatable
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Check if a path and its alias have the same required params
 *
 * <span class="token keyword">@param</span> <span class="token parameter">a</span> - original record
 * <span class="token keyword">@param</span> <span class="token parameter">b</span> - alias record
 */</span>
<span class="token keyword">function</span> <span class="token function">checkSameParams</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> a<span class="token punctuation">.</span>keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">.</span>optional <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>b<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token function">isSameParam</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Alias &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>b<span class="token punctuation">.</span>record<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; and the original record: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>a<span class="token punctuation">.</span>record<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; should have the exact same param named &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> b<span class="token punctuation">.</span>keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">.</span>optional <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>a<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token function">isSameParam</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Alias &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>b<span class="token punctuation">.</span>record<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; and the original record: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>a<span class="token punctuation">.</span>record<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; should have the exact same param named &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">checkMissingParamsInAbsolutePath</span><span class="token punctuation">(</span><span class="token parameter">record<span class="token punctuation">,</span> parent</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> parent<span class="token punctuation">.</span>keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>record<span class="token punctuation">.</span>keys<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token function">isSameParam</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Absolute path &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>record<span class="token punctuation">.</span>record<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; should have the exact same param named &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; as its parent &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>parent<span class="token punctuation">.</span>record<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * Encoding Rules ␣ = Space Path: ␣ &quot; &lt; &gt; # ? <span class="token punctuation">{</span> <span class="token punctuation">}</span> Query: ␣ &quot; &lt; &gt; # &amp; = Hash: ␣ &quot;
 * &lt; &gt; `
 *
 * On top of that, the RFC3986 (https://tools.ietf.org/html/rfc3986#section-2.2)
 * defines some extra characters to be encoded. Most browsers do not encode them
 * in encodeURI https://github.com/whatwg/url/issues/369, so it may be safer to
 * also encode `!&#39;()*`. Leaving unencoded only ASCII alphanumeric(`a-zA-Z0-9`)
 * plus `-._~`. This extra safety should be applied to query by patching the
 * string returned by encodeURIComponent encodeURI also encodes `[\]^`. `\`
 * should be encoded to avoid ambiguity. Browsers (IE, FF, C) transform a `\`
 * into a `/` if directly typed in. The _backtick_ (`````) should also be
 * encoded everywhere because some browsers like FF encode it when directly
 * written while others don&#39;t. Safari and IE don&#39;t encode ``&quot;&lt;&gt;<span class="token punctuation">{</span><span class="token punctuation">}</span>``` in hash.
 */</span>
<span class="token comment">// const EXTRA_RESERVED_RE = /[!&#39;()*]/g</span>
<span class="token comment">// const encodeReservedReplacer = (c: string) =&gt; &#39;%&#39; + c.charCodeAt(0).toString(16)</span>
<span class="token keyword">const</span> <span class="token constant">HASH_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">#</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span> <span class="token comment">// %23</span>
<span class="token keyword">const</span> <span class="token constant">AMPERSAND_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&amp;</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span> <span class="token comment">// %26</span>
<span class="token keyword">const</span> <span class="token constant">SLASH_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span> <span class="token comment">// %2F</span>
<span class="token keyword">const</span> <span class="token constant">EQUAL_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">=</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span> <span class="token comment">// %3D</span>
<span class="token keyword">const</span> <span class="token constant">IM_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\?</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span> <span class="token comment">// %3F</span>
<span class="token keyword">const</span> <span class="token constant">PLUS_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span> <span class="token comment">// %2B</span>
<span class="token doc-comment comment">/**
 * NOTE: It&#39;s not clear to me if we should encode the + symbol in queries, it
 * seems to be less flexible than not doing so and I can&#39;t find out the legacy
 * systems requiring this for regular requests like text/html. In the standard,
 * the encoding of the plus character is only mentioned for
 * application/x-www-form-urlencoded
 * (https://url.spec.whatwg.org/#urlencoded-parsing) and most browsers seems lo
 * leave the plus character as is in queries. To be more flexible, we allow the
 * plus character on the query but it can also be manually encoded by the user.
 *
 * Resources:
 * - https://url.spec.whatwg.org/#urlencoded-parsing
 * - https://stackoverflow.com/questions/1634271/url-encoding-the-space-character-or-20
 */</span>
<span class="token keyword">const</span> <span class="token constant">ENC_BRACKET_OPEN_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%5B</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span> <span class="token comment">// [</span>
<span class="token keyword">const</span> <span class="token constant">ENC_BRACKET_CLOSE_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%5D</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span> <span class="token comment">// ]</span>
<span class="token keyword">const</span> <span class="token constant">ENC_CARET_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%5E</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span> <span class="token comment">// ^</span>
<span class="token keyword">const</span> <span class="token constant">ENC_BACKTICK_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%60</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span> <span class="token comment">// `</span>
<span class="token keyword">const</span> <span class="token constant">ENC_CURLY_OPEN_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%7B</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span> <span class="token comment">// {</span>
<span class="token keyword">const</span> <span class="token constant">ENC_PIPE_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%7C</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span> <span class="token comment">// |</span>
<span class="token keyword">const</span> <span class="token constant">ENC_CURLY_CLOSE_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%7D</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span> <span class="token comment">// }</span>
<span class="token keyword">const</span> <span class="token constant">ENC_SPACE_RE</span> <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">%20</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span> <span class="token comment">// }</span>
<span class="token doc-comment comment">/**
 * Encode characters that need to be encoded on the path, search and hash
 * sections of the URL.
 *
 * <span class="token keyword">@internal</span>
 * <span class="token keyword">@param</span> <span class="token parameter">text</span> - string to encode
 * <span class="token keyword">@returns</span> encoded string
 */</span>
<span class="token keyword">function</span> <span class="token function">commonEncode</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">encodeURI</span><span class="token punctuation">(</span><span class="token string">&#39;&#39;</span> <span class="token operator">+</span> text<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">ENC_PIPE_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;|&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">ENC_BRACKET_OPEN_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;[&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">ENC_BRACKET_CLOSE_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;]&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Encode characters that need to be encoded on the hash section of the URL.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">text</span> - string to encode
 * <span class="token keyword">@returns</span> encoded string
 */</span>
<span class="token keyword">function</span> <span class="token function">encodeHash</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">commonEncode</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">ENC_CURLY_OPEN_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;{&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">ENC_CURLY_CLOSE_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;}&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">ENC_CARET_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;^&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Encode characters that need to be encoded query values on the query
 * section of the URL.
 *
 * <span class="token keyword">@param</span> <span class="token parameter">text</span> - string to encode
 * <span class="token keyword">@returns</span> encoded string
 */</span>
<span class="token keyword">function</span> <span class="token function">encodeQueryValue</span><span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token function">commonEncode</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
      <span class="token comment">// Encode the space as +, encode the + to differentiate it from the space</span>
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">PLUS_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;%2B&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">ENC_SPACE_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;+&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">HASH_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;%23&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">AMPERSAND_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;%26&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">ENC_BACKTICK_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;`&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">ENC_CURLY_OPEN_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;{&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">ENC_CURLY_CLOSE_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;}&#39;</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token constant">ENC_CARET_RE</span><span class="token punctuation">,</span> <span class="token string">&#39;^&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Like `encodeQueryValue</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> but also encodes the </span><span class="token template-punctuation string">`</span></span><span class="token operator">=</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> character.
 *
 * @param text - string to encode
 */
function encodeQueryKey(text) {
  return encodeQueryValue(text).replace(EQUAL_RE, &#39;%3D&#39;);
}
/**
 * Encode characters that need to be encoded on the path section of the URL.
 *
 * @param text - string to encode
 * @returns encoded string
 */
function encodePath(text) {
  return commonEncode(text).replace(HASH_RE, &#39;%23&#39;).replace(IM_RE, &#39;%3F&#39;);
}
/**
 * Encode characters that need to be encoded on the path section of the URL as a
 * param. This function encodes everything {@link encodePath} does plus the
 * slash (</span><span class="token template-punctuation string">`</span></span><span class="token operator">/</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">) character. If </span><span class="token template-punctuation string">`</span></span>text<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> is </span><span class="token template-punctuation string">`</span></span><span class="token keyword">null</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> or </span><span class="token template-punctuation string">`</span></span><span class="token keyword">undefined</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">, returns an empty
 * string instead.
 *
 * @param text - string to encode
 * @returns encoded string
 */
function encodeParam(text) {
  return text == null ? &#39;&#39; : encodePath(text).replace(SLASH_RE, &#39;%2F&#39;);
}
/**
 * Decode text using </span><span class="token template-punctuation string">`</span></span>decodeURIComponent<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">. Returns the original text if it
 * fails.
 *
 * @param text - string to decode
 * @returns decoded string
 */
function decode(text) {
  try {
    return decodeURIComponent(&#39;&#39; + text);
  } catch (err) {
    warn(</span><span class="token template-punctuation string">`</span></span>Error decoding <span class="token string">&quot;${text}&quot;</span><span class="token punctuation">.</span> Using original value<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">);
  }
  return &#39;&#39; + text;
}

/**
 * Transforms a queryString into a {@link LocationQuery} object. Accept both, a
 * version with the leading </span><span class="token template-punctuation string">`</span></span><span class="token operator">?</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> and without Should work as URLSearchParams

 * @internal
 *
 * @param search - search string to parse
 * @returns a query object
 */
function parseQuery(search) {
  const query = {};
  // avoid creating an object with an empty key and empty value
  // because of split(&#39;&amp;&#39;)
  if (search === &#39;&#39; || search === &#39;?&#39;) return query;
  const hasLeadingIM = search[0] === &#39;?&#39;;
  const searchParams = (hasLeadingIM ? search.slice(1) : search).split(&#39;&amp;&#39;);
  for (let i = 0; i &lt; searchParams.length; ++i) {
    // pre decode the + into space
    const searchParam = searchParams[i].replace(PLUS_RE, &#39; &#39;);
    // allow the = character
    const eqPos = searchParam.indexOf(&#39;=&#39;);
    const key = decode(eqPos &lt; 0 ? searchParam : searchParam.slice(0, eqPos));
    const value = eqPos &lt; 0 ? null : decode(searchParam.slice(eqPos + 1));
    if (key in query) {
      // an extra variable for ts types
      let currentValue = query[key];
      if (!Array.isArray(currentValue)) {
        currentValue = query[key] = [currentValue];
      }
      currentValue.push(value);
    } else {
      query[key] = value;
    }
  }
  return query;
}
/**
 * Stringifies a {@link LocationQueryRaw} object. Like </span><span class="token template-punctuation string">`</span></span>URLSearchParams<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">, it
 * doesn&#39;t prepend a </span><span class="token template-punctuation string">`</span></span><span class="token operator">?</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
 *
 * @internal
 *
 * @param query - query object to stringify
 * @returns string version of the query without the leading </span><span class="token template-punctuation string">`</span></span><span class="token operator">?</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
 */
function stringifyQuery(query) {
  let search = &#39;&#39;;
  for (let key in query) {
    const value = query[key];
    key = encodeQueryKey(key);
    if (value == null) {
      // only null adds the value
      if (value !== undefined) {
        search += (search.length ? &#39;&amp;&#39; : &#39;&#39;) + key;
      }
      continue;
    }
    // keep null values
    const values = Array.isArray(value)
      ? value.map((v) =&gt; v &amp;&amp; encodeQueryValue(v))
      : [value &amp;&amp; encodeQueryValue(value)];
    values.forEach((value) =&gt; {
      // skip undefined values in arrays as if they were not present
      // smaller code than using filter
      if (value !== undefined) {
        // only append &amp; with non-empty search
        search += (search.length ? &#39;&amp;&#39; : &#39;&#39;) + key;
        if (value != null) search += &#39;=&#39; + value;
      }
    });
  }
  return search;
}
/**
 * Transforms a {@link LocationQueryRaw} into a {@link LocationQuery} by casting
 * numbers into strings, removing keys with an undefined value and replacing
 * undefined with null in arrays
 *
 * @param query - query object to normalize
 * @returns a normalized query object
 */
function normalizeQuery(query) {
  const normalizedQuery = {};
  for (const key in query) {
    const value = query[key];
    if (value !== undefined) {
      normalizedQuery[key] = Array.isArray(value)
        ? value.map((v) =&gt; (v == null ? null : &#39;&#39; + v))
        : value == null
        ? value
        : &#39;&#39; + value;
    }
  }
  return normalizedQuery;
}

/**
 * Create a list of callbacks that can be reset. Used to create before and after navigation guards list
 */
function useCallbacks() {
  let handlers = [];
  function add(handler) {
    handlers.push(handler);
    return () =&gt; {
      const i = handlers.indexOf(handler);
      if (i &gt; -1) handlers.splice(i, 1);
    };
  }
  function reset() {
    handlers = [];
  }
  return {
    add,
    list: () =&gt; handlers,
    reset,
  };
}

function registerGuard(record, name, guard) {
  const removeFromList = () =&gt; {
    record[name].delete(guard);
  };
  onUnmounted(removeFromList);
  onDeactivated(removeFromList);
  onActivated(() =&gt; {
    record[name].add(guard);
  });
  record[name].add(guard);
}
/**
 * Add a navigation guard that triggers whenever the component for the current
 * location is about to be left. Similar to {@link beforeRouteLeave} but can be
 * used in any component. The guard is removed when the component is unmounted.
 *
 * @param leaveGuard - {@link NavigationGuard}
 */
function onBeforeRouteLeave(leaveGuard) {
  if (!getCurrentInstance()) {
    warn(
      &#39;getCurrentInstance() returned null. onBeforeRouteLeave() must be called at the top of a setup function&#39;
    );
    return;
  }
  const activeRecord = inject(
    matchedRouteKey,
    // to avoid warning
    {}
  ).value;
  if (!activeRecord) {
    warn(
      &#39;No active route record was found when calling </span><span class="token template-punctuation string">`</span></span><span class="token function">onBeforeRouteLeave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">. Make sure you call this function inside of a component child of &lt;router-view&gt;. Maybe you called it inside of App.vue?&#39;
    );
    return;
  }
  registerGuard(activeRecord, &#39;leaveGuards&#39;, leaveGuard);
}
/**
 * Add a navigation guard that triggers whenever the current location is about
 * to be updated. Similar to {@link beforeRouteUpdate} but can be used in any
 * component. The guard is removed when the component is unmounted.
 *
 * @param updateGuard - {@link NavigationGuard}
 */
function onBeforeRouteUpdate(updateGuard) {
  if (!getCurrentInstance()) {
    warn(
      &#39;getCurrentInstance() returned null. onBeforeRouteUpdate() must be called at the top of a setup function&#39;
    );
    return;
  }
  const activeRecord = inject(
    matchedRouteKey,
    // to avoid warning
    {}
  ).value;
  if (!activeRecord) {
    warn(
      &#39;No active route record was found when calling </span><span class="token template-punctuation string">`</span></span><span class="token function">onBeforeRouteUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">. Make sure you call this function inside of a component child of &lt;router-view&gt;. Maybe you called it inside of App.vue?&#39;
    );
    return;
  }
  registerGuard(activeRecord, &#39;updateGuards&#39;, updateGuard);
}
function guardToPromiseFn(guard, to, from, record, name) {
  // keep a reference to the enterCallbackArray to prevent pushing callbacks if a new navigation took place
  const enterCallbackArray =
    record &amp;&amp;
    // name is defined if record is because of the function overload
    (record.enterCallbacks[name] = record.enterCallbacks[name] || []);
  return () =&gt;
    new Promise((resolve, reject) =&gt; {
      const next = (valid) =&gt; {
        if (valid === false)
          reject(
            createRouterError(4 /* NAVIGATION_ABORTED */, {
              from,
              to,
            })
          );
        else if (valid instanceof Error) {
          reject(valid);
        } else if (isRouteLocation(valid)) {
          reject(
            createRouterError(2 /* NAVIGATION_GUARD_REDIRECT */, {
              from: to,
              to: valid,
            })
          );
        } else {
          if (
            enterCallbackArray &amp;&amp;
            // since enterCallbackArray is truthy, both record and name also are
            record.enterCallbacks[name] === enterCallbackArray &amp;&amp;
            typeof valid === &#39;function&#39;
          )
            enterCallbackArray.push(valid);
          resolve();
        }
      };
      // wrapping with Promise.resolve allows it to work with both async and sync guards
      const guardReturn = guard.call(
        record &amp;&amp; record.instances[name],
        to,
        from,
        canOnlyBeCalledOnce(next, to, from)
      );
      let guardCall = Promise.resolve(guardReturn);
      if (guard.length &lt; 3) guardCall = guardCall.then(next);
      if (guard.length &gt; 2) {
        const message = </span><span class="token template-punctuation string">`</span></span>The <span class="token string">&quot;next&quot;</span> callback was never called inside <span class="token keyword">of</span> $<span class="token punctuation">{</span>
          guard<span class="token punctuation">.</span>name <span class="token operator">?</span> <span class="token string">&#39;&quot;&#39;</span> <span class="token operator">+</span> guard<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&#39;&quot;&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;&#39;</span>
        <span class="token punctuation">}</span><span class="token operator">:</span>\n$<span class="token punctuation">{</span>guard<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>\n<span class="token punctuation">.</span> If you are returning a value instead <span class="token keyword">of</span> calling <span class="token string">&quot;next&quot;</span><span class="token punctuation">,</span> make sure to remove the <span class="token string">&quot;next&quot;</span> parameter from your <span class="token keyword">function</span><span class="token punctuation">.</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">;
        if (typeof guardReturn === &#39;object&#39; &amp;&amp; &#39;then&#39; in guardReturn) {
          guardCall = guardCall.then((resolvedValue) =&gt; {
            // @ts-expect-error: _called is added at canOnlyBeCalledOnce
            if (!next._called) {
              warn(message);
              return Promise.reject(new Error(&#39;Invalid navigation guard&#39;));
            }
            return resolvedValue;
          });
          // TODO: test me!
        } else if (guardReturn !== undefined) {
          // @ts-expect-error: _called is added at canOnlyBeCalledOnce
          if (!next._called) {
            warn(message);
            reject(new Error(&#39;Invalid navigation guard&#39;));
            return;
          }
        }
      }
      guardCall.catch((err) =&gt; reject(err));
    });
}
function canOnlyBeCalledOnce(next, to, from) {
  let called = 0;
  return function () {
    if (called++ === 1)
      warn(
        </span><span class="token template-punctuation string">`</span></span>The <span class="token string">&quot;next&quot;</span> callback was called more than once <span class="token keyword">in</span> one navigation guard when going <span class="token keyword">from</span> <span class="token string">&quot;${from.fullPath}&quot;</span> to <span class="token string">&quot;${to.fullPath}&quot;</span><span class="token punctuation">.</span> It should be called exactly one time <span class="token keyword">in</span> each navigation guard<span class="token punctuation">.</span> This will fail <span class="token keyword">in</span> production<span class="token punctuation">.</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      );
    // @ts-expect-error: we put it in the original one because it&#39;s easier to check
    next._called = true;
    if (called === 1) next.apply(null, arguments);
  };
}
function extractComponentsGuards(matched, guardType, to, from) {
  const guards = [];
  for (const record of matched) {
    for (const name in record.components) {
      let rawComponent = record.components[name];
      {
        if (
          !rawComponent ||
          (typeof rawComponent !== &#39;object&#39; &amp;&amp;
            typeof rawComponent !== &#39;function&#39;)
        ) {
          warn(
            </span><span class="token template-punctuation string">`</span></span>Component <span class="token string">&quot;${name}&quot;</span> <span class="token keyword">in</span> record <span class="token keyword">with</span> path <span class="token string">&quot;${record.path}&quot;</span> is not<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> +
              </span><span class="token template-punctuation string">`</span></span> a valid component<span class="token punctuation">.</span> Received <span class="token string">&quot;${String(rawComponent)}&quot;</span><span class="token punctuation">.</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
          );
          // throw to ensure we stop here but warn to ensure the message isn&#39;t
          // missed by the user
          throw new Error(&#39;Invalid route component&#39;);
        } else if (&#39;then&#39; in rawComponent) {
          // warn if user wrote import(&#39;/component.vue&#39;) instead of () =&gt;
          // import(&#39;./component.vue&#39;)
          warn(
            </span><span class="token template-punctuation string">`</span></span>Component <span class="token string">&quot;${name}&quot;</span> <span class="token keyword">in</span> record <span class="token keyword">with</span> path <span class="token string">&quot;${record.path}&quot;</span> is a <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> +
              </span><span class="token template-punctuation string">`</span></span>Promise instead <span class="token keyword">of</span> a <span class="token keyword">function</span> that returns a Promise<span class="token punctuation">.</span> Did you <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> +
              </span><span class="token template-punctuation string">`</span></span>write <span class="token string">&quot;import(&#39;./MyPage.vue&#39;)&quot;</span> instead <span class="token keyword">of</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> +
              </span><span class="token template-punctuation string">`</span></span><span class="token string">&quot;() =&gt; import(&#39;./MyPage.vue&#39;)&quot;</span> <span class="token operator">?</span> This will <span class="token keyword">break</span> <span class="token keyword">in</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> +
              </span><span class="token template-punctuation string">`</span></span>production <span class="token keyword">if</span> not fixed<span class="token punctuation">.</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
          );
          const promise = rawComponent;
          rawComponent = () =&gt; promise;
        } else if (
          rawComponent.__asyncLoader &amp;&amp;
          // warn only once per component
          !rawComponent.__warnedDefineAsync
        ) {
          rawComponent.__warnedDefineAsync = true;
          warn(
            </span><span class="token template-punctuation string">`</span></span>Component <span class="token string">&quot;${name}&quot;</span> <span class="token keyword">in</span> record <span class="token keyword">with</span> path <span class="token string">&quot;${record.path}&quot;</span> is defined <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> +
              </span><span class="token template-punctuation string">`</span></span>using <span class="token string">&quot;defineAsyncComponent()&quot;</span><span class="token punctuation">.</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> +
              </span><span class="token template-punctuation string">`</span></span>Write <span class="token string">&quot;() =&gt; import(&#39;./MyPage.vue&#39;)&quot;</span> instead <span class="token keyword">of</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> +
              </span><span class="token template-punctuation string">`</span></span><span class="token string">&quot;defineAsyncComponent(() =&gt; import(&#39;./MyPage.vue&#39;))&quot;</span><span class="token punctuation">.</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
          );
        }
      }
      // skip update and leave guards if the route component is not mounted
      if (guardType !== &#39;beforeRouteEnter&#39; &amp;&amp; !record.instances[name]) continue;
      if (isRouteComponent(rawComponent)) {
        // __vccOpts is added by vue-class-component and contain the regular options
        const options = rawComponent.__vccOpts || rawComponent;
        const guard = options[guardType];
        guard &amp;&amp; guards.push(guardToPromiseFn(guard, to, from, record, name));
      } else {
        // start requesting the chunk already
        let componentPromise = rawComponent();
        if (!(&#39;catch&#39; in componentPromise)) {
          warn(
            </span><span class="token template-punctuation string">`</span></span>Component <span class="token string">&quot;${name}&quot;</span> <span class="token keyword">in</span> record <span class="token keyword">with</span> path <span class="token string">&quot;${record.path}&quot;</span> is a <span class="token keyword">function</span> that does not <span class="token keyword">return</span> a Promise<span class="token punctuation">.</span> If you were passing a functional component<span class="token punctuation">,</span> make sure to add a <span class="token string">&quot;displayName&quot;</span> to the component<span class="token punctuation">.</span> This will <span class="token keyword">break</span> <span class="token keyword">in</span> production <span class="token keyword">if</span> not fixed<span class="token punctuation">.</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
          );
          componentPromise = Promise.resolve(componentPromise);
        }
        guards.push(() =&gt;
          componentPromise.then((resolved) =&gt; {
            if (!resolved)
              return Promise.reject(
                new Error(
                  </span><span class="token template-punctuation string">`</span></span>Couldn&#39;t resolve component <span class="token string">&quot;${name}&quot;</span> at <span class="token string">&quot;${record.path}&quot;</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
                )
              );
            const resolvedComponent = isESModule(resolved)
              ? resolved.default
              : resolved;
            // replace the function with the resolved component
            record.components[name] = resolvedComponent;
            // __vccOpts is added by vue-class-component and contain the regular options
            const options = resolvedComponent.__vccOpts || resolvedComponent;
            const guard = options[guardType];
            return guard &amp;&amp; guardToPromiseFn(guard, to, from, record, name)();
          })
        );
      }
    }
  }
  return guards;
}
/**
 * Allows differentiating lazy components from functional components and vue-class-component
 *
 * @param component
 */
function isRouteComponent(component) {
  return (
    typeof component === &#39;object&#39; ||
    &#39;displayName&#39; in component ||
    &#39;props&#39; in component ||
    &#39;__vccOpts&#39; in component
  );
}

// TODO: we could allow currentRoute as a prop to expose </span><span class="token template-punctuation string">`</span></span>isActive<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> and
// </span><span class="token template-punctuation string">`</span></span>isExactActive<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> behavior should go through an RFC
function useLink(props) {
  const router = inject(routerKey);
  const currentRoute = inject(routeLocationKey);
  const route = computed(() =&gt; router.resolve(unref(props.to)));
  const activeRecordIndex = computed(() =&gt; {
    const { matched } = route.value;
    const { length } = matched;
    const routeMatched = matched[length - 1];
    const currentMatched = currentRoute.matched;
    if (!routeMatched || !currentMatched.length) return -1;
    const index = currentMatched.findIndex(
      isSameRouteRecord.bind(null, routeMatched)
    );
    if (index &gt; -1) return index;
    // possible parent record
    const parentRecordPath = getOriginalPath(matched[length - 2]);
    return (
      // we are dealing with nested routes
      length &gt; 1 &amp;&amp;
        // if the parent and matched route have the same path, this link is
        // referring to the empty child. Or we currently are on a different
        // child of the same parent
        getOriginalPath(routeMatched) === parentRecordPath &amp;&amp;
        // avoid comparing the child with its parent
        currentMatched[currentMatched.length - 1].path !== parentRecordPath
        ? currentMatched.findIndex(
            isSameRouteRecord.bind(null, matched[length - 2])
          )
        : index
    );
  });
  const isActive = computed(
    () =&gt;
      activeRecordIndex.value &gt; -1 &amp;&amp;
      includesParams(currentRoute.params, route.value.params)
  );
  const isExactActive = computed(
    () =&gt;
      activeRecordIndex.value &gt; -1 &amp;&amp;
      activeRecordIndex.value === currentRoute.matched.length - 1 &amp;&amp;
      isSameRouteLocationParams(currentRoute.params, route.value.params)
  );
  function navigate(e = {}) {
    if (guardEvent(e)) {
      return router[unref(props.replace) ? &#39;replace&#39; : &#39;push&#39;](
        unref(props.to)
        // avoid uncaught errors are they are logged anyway
      ).catch(noop);
    }
    return Promise.resolve();
  }
  // devtools only
  if (isBrowser) {
    const instance = getCurrentInstance();
    if (instance) {
      const linkContextDevtools = {
        route: route.value,
        isActive: isActive.value,
        isExactActive: isExactActive.value,
      };
      // @ts-expect-error: this is internal
      instance.__vrl_devtools = instance.__vrl_devtools || [];
      // @ts-expect-error: this is internal
      instance.__vrl_devtools.push(linkContextDevtools);
      watchEffect(
        () =&gt; {
          linkContextDevtools.route = route.value;
          linkContextDevtools.isActive = isActive.value;
          linkContextDevtools.isExactActive = isExactActive.value;
        },
        { flush: &#39;post&#39; }
      );
    }
  }
  return {
    route,
    href: computed(() =&gt; route.value.href),
    isActive,
    isExactActive,
    navigate,
  };
}
const RouterLinkImpl = /*#__PURE__*/ defineComponent({
  name: &#39;RouterLink&#39;,
  props: {
    to: {
      type: [String, Object],
      required: true,
    },
    replace: Boolean,
    activeClass: String,
    // inactiveClass: String,
    exactActiveClass: String,
    custom: Boolean,
    ariaCurrentValue: {
      type: String,
      default: &#39;page&#39;,
    },
  },
  useLink,
  setup(props, { slots }) {
    const link = reactive(useLink(props));
    const { options } = inject(routerKey);
    const elClass = computed(() =&gt; ({
      [getLinkClass(
        props.activeClass,
        options.linkActiveClass,
        &#39;router-link-active&#39;
      )]: link.isActive,
      // [getLinkClass(
      //   props.inactiveClass,
      //   options.linkInactiveClass,
      //   &#39;router-link-inactive&#39;
      // )]: !link.isExactActive,
      [getLinkClass(
        props.exactActiveClass,
        options.linkExactActiveClass,
        &#39;router-link-exact-active&#39;
      )]: link.isExactActive,
    }));
    return () =&gt; {
      const children = slots.default &amp;&amp; slots.default(link);
      return props.custom
        ? children
        : h(
            &#39;a&#39;,
            {
              &#39;aria-current&#39;: link.isExactActive
                ? props.ariaCurrentValue
                : null,
              href: link.href,
              // this would override user added attrs but Vue will still add
              // the listener so we end up triggering both
              onClick: link.navigate,
              class: elClass.value,
            },
            children
          );
    };
  },
});
// export the public type for h/tsx inference
// also to avoid inline import() in generated d.ts files
/**
 * Component to render a link that triggers a navigation on click.
 */
const RouterLink = RouterLinkImpl;
function guardEvent(e) {
  // don&#39;t redirect with control keys
  if (e.metaKey || e.altKey || e.ctrlKey || e.shiftKey) return;
  // don&#39;t redirect when preventDefault called
  if (e.defaultPrevented) return;
  // don&#39;t redirect on right click
  if (e.button !== undefined &amp;&amp; e.button !== 0) return;
  // don&#39;t redirect if </span><span class="token template-punctuation string">`</span></span>target<span class="token operator">=</span><span class="token string">&quot;_blank&quot;</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  // @ts-expect-error getAttribute does exist
  if (e.currentTarget &amp;&amp; e.currentTarget.getAttribute) {
    // @ts-expect-error getAttribute exists
    const target = e.currentTarget.getAttribute(&#39;target&#39;);
    if (/\b_blank\b/i.test(target)) return;
  }
  // this may be a Weex event which doesn&#39;t have this method
  if (e.preventDefault) e.preventDefault();
  return true;
}
function includesParams(outer, inner) {
  for (const key in inner) {
    const innerValue = inner[key];
    const outerValue = outer[key];
    if (typeof innerValue === &#39;string&#39;) {
      if (innerValue !== outerValue) return false;
    } else {
      if (
        !Array.isArray(outerValue) ||
        outerValue.length !== innerValue.length ||
        innerValue.some((value, i) =&gt; value !== outerValue[i])
      )
        return false;
    }
  }
  return true;
}
/**
 * Get the original path value of a record by following its aliasOf
 * @param record
 */
function getOriginalPath(record) {
  return record ? (record.aliasOf ? record.aliasOf.path : record.path) : &#39;&#39;;
}
/**
 * Utility class to get the active class based on defaults.
 * @param propClass
 * @param globalClass
 * @param defaultClass
 */
const getLinkClass = (propClass, globalClass, defaultClass) =&gt;
  propClass != null
    ? propClass
    : globalClass != null
    ? globalClass
    : defaultClass;

const RouterViewImpl = /*#__PURE__*/ defineComponent({
  name: &#39;RouterView&#39;,
  // #674 we manually inherit them
  inheritAttrs: false,
  props: {
    name: {
      type: String,
      default: &#39;default&#39;,
    },
    route: Object,
  },
  setup(props, { attrs, slots }) {
    warnDeprecatedUsage();
    const injectedRoute = inject(routerViewLocationKey);
    const routeToDisplay = computed(() =&gt; props.route || injectedRoute.value);
    const depth = inject(viewDepthKey, 0);
    const matchedRouteRef = computed(() =&gt; routeToDisplay.value.matched[depth]);
    provide(viewDepthKey, depth + 1);
    provide(matchedRouteKey, matchedRouteRef);
    provide(routerViewLocationKey, routeToDisplay);
    const viewRef = ref();
    // watch at the same time the component instance, the route record we are
    // rendering, and the name
    watch(
      () =&gt; [viewRef.value, matchedRouteRef.value, props.name],
      ([instance, to, name], [oldInstance, from, oldName]) =&gt; {
        // copy reused instances
        if (to) {
          // this will update the instance for new instances as well as reused
          // instances when navigating to a new route
          to.instances[name] = instance;
          // the component instance is reused for a different route or name so
          // we copy any saved update or leave guards. With async setup, the
          // mounting component will mount before the matchedRoute changes,
          // making instance === oldInstance, so we check if guards have been
          // added before. This works because we remove guards when
          // unmounting/deactivating components
          if (from &amp;&amp; from !== to &amp;&amp; instance &amp;&amp; instance === oldInstance) {
            if (!to.leaveGuards.size) {
              to.leaveGuards = from.leaveGuards;
            }
            if (!to.updateGuards.size) {
              to.updateGuards = from.updateGuards;
            }
          }
        }
        // trigger beforeRouteEnter next callbacks
        if (
          instance &amp;&amp;
          to &amp;&amp;
          // if there is no instance but to and from are the same this might be
          // the first visit
          (!from || !isSameRouteRecord(to, from) || !oldInstance)
        ) {
          (to.enterCallbacks[name] || []).forEach((callback) =&gt;
            callback(instance)
          );
        }
      },
      { flush: &#39;post&#39; }
    );
    return () =&gt; {
      const route = routeToDisplay.value;
      const matchedRoute = matchedRouteRef.value;
      const ViewComponent = matchedRoute &amp;&amp; matchedRoute.components[props.name];
      // we need the value at the time we render because when we unmount, we
      // navigated to a different location so the value is different
      const currentName = props.name;
      if (!ViewComponent) {
        return normalizeSlot(slots.default, {
          Component: ViewComponent,
          route,
        });
      }
      // props from route configuration
      const routePropsOption = matchedRoute.props[props.name];
      const routeProps = routePropsOption
        ? routePropsOption === true
          ? route.params
          : typeof routePropsOption === &#39;function&#39;
          ? routePropsOption(route)
          : routePropsOption
        : null;
      const onVnodeUnmounted = (vnode) =&gt; {
        // remove the instance reference to prevent leak
        if (vnode.component.isUnmounted) {
          matchedRoute.instances[currentName] = null;
        }
      };
      const component = h(
        ViewComponent,
        assign({}, routeProps, attrs, {
          onVnodeUnmounted,
          ref: viewRef,
        })
      );
      if (isBrowser &amp;&amp; component.ref) {
        // TODO: can display if it&#39;s an alias, its props
        const info = {
          depth,
          name: matchedRoute.name,
          path: matchedRoute.path,
          meta: matchedRoute.meta,
        };
        const internalInstances = Array.isArray(component.ref)
          ? component.ref.map((r) =&gt; r.i)
          : [component.ref.i];
        internalInstances.forEach((instance) =&gt; {
          // @ts-expect-error
          instance.__vrv_devtools = info;
        });
      }
      return (
        // pass the vnode to the slot as a prop.
        // h and &lt;component :is=&quot;...&quot;&gt; both accept vnodes
        normalizeSlot(slots.default, { Component: component, route }) ||
        component
      );
    };
  },
});
function normalizeSlot(slot, data) {
  if (!slot) return null;
  const slotContent = slot(data);
  return slotContent.length === 1 ? slotContent[0] : slotContent;
}
// export the public type for h/tsx inference
// also to avoid inline import() in generated d.ts files
/**
 * Component to display the current route the user is at.
 */
const RouterView = RouterViewImpl;
// warn against deprecated usage with &lt;transition&gt; &amp; &lt;keep-alive&gt;
// due to functional component being no longer eager in Vue 3
function warnDeprecatedUsage() {
  const instance = getCurrentInstance();
  const parentName = instance.parent &amp;&amp; instance.parent.type.name;
  if (
    parentName &amp;&amp;
    (parentName === &#39;KeepAlive&#39; || parentName.includes(&#39;Transition&#39;))
  ) {
    const comp = parentName === &#39;KeepAlive&#39; ? &#39;keep-alive&#39; : &#39;transition&#39;;
    warn(
      </span><span class="token template-punctuation string">`</span></span><span class="token operator">&lt;</span>router<span class="token operator">-</span>view<span class="token operator">&gt;</span> can no longer be used directly inside <span class="token operator">&lt;</span>transition<span class="token operator">&gt;</span> or <span class="token operator">&lt;</span>keep<span class="token operator">-</span>alive<span class="token operator">&gt;</span><span class="token punctuation">.</span>\n<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> +
        </span><span class="token template-punctuation string">`</span></span>Use slot props instead<span class="token operator">:</span>\n\n<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> +
        </span><span class="token template-punctuation string">`</span></span><span class="token operator">&lt;</span>router<span class="token operator">-</span>view v<span class="token operator">-</span>slot<span class="token operator">=</span><span class="token string">&quot;{ Component }&quot;</span><span class="token operator">&gt;</span>\n<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> +
        </span><span class="token template-punctuation string">`</span></span>  <span class="token operator">&lt;</span>$<span class="token punctuation">{</span>comp<span class="token punctuation">}</span><span class="token operator">&gt;</span>\n<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> +
        </span><span class="token template-punctuation string">`</span></span>    <span class="token operator">&lt;</span>component <span class="token operator">:</span>is<span class="token operator">=</span><span class="token string">&quot;Component&quot;</span> <span class="token operator">/</span><span class="token operator">&gt;</span>\n<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> +
        </span><span class="token template-punctuation string">`</span></span>  <span class="token operator">&lt;</span><span class="token operator">/</span>$<span class="token punctuation">{</span>comp<span class="token punctuation">}</span><span class="token operator">&gt;</span>\n<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> +
        </span><span class="token template-punctuation string">`</span></span><span class="token operator">&lt;</span><span class="token operator">/</span>router<span class="token operator">-</span>view<span class="token operator">&gt;</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    );
  }
}

function formatRouteLocation(routeLocation, tooltip) {
  const copy = assign({}, routeLocation, {
    // remove variables that can contain vue instances
    matched: routeLocation.matched.map((matched) =&gt;
      omit(matched, [&#39;instances&#39;, &#39;children&#39;, &#39;aliasOf&#39;])
    ),
  });
  return {
    _custom: {
      type: null,
      readOnly: true,
      display: routeLocation.fullPath,
      tooltip,
      value: copy,
    },
  };
}
function formatDisplay(display) {
  return {
    _custom: {
      display,
    },
  };
}
// to support multiple router instances
let routerId = 0;
function addDevtools(app, router, matcher) {
  // Take over router.beforeEach and afterEach
  // make sure we are not registering the devtool twice
  if (router.__hasDevtools) return;
  router.__hasDevtools = true;
  // increment to support multiple router instances
  const id = routerId++;
  setupDevtoolsPlugin(
    {
      id: &#39;org.vuejs.router&#39; + (id ? &#39;.&#39; + id : &#39;&#39;),
      label: &#39;Vue Router&#39;,
      packageName: &#39;vue-router&#39;,
      homepage: &#39;https://next.router.vuejs.org/&#39;,
      logo: &#39;https://vuejs.org/images/icons/favicon-96x96.png&#39;,
      componentStateTypes: [&#39;Routing&#39;],
      app,
    },
    (api) =&gt; {
      // display state added by the router
      api.on.inspectComponent((payload, ctx) =&gt; {
        if (payload.instanceData) {
          payload.instanceData.state.push({
            type: &#39;Routing&#39;,
            key: &#39;$route&#39;,
            editable: false,
            value: formatRouteLocation(
              router.currentRoute.value,
              &#39;Current Route&#39;
            ),
          });
        }
      });
      // mark router-link as active and display tags on router views
      api.on.visitComponentTree(({ treeNode: node, componentInstance }) =&gt; {
        if (componentInstance.__vrv_devtools) {
          const info = componentInstance.__vrv_devtools;
          node.tags.push({
            label: (info.name ? </span><span class="token template-punctuation string">`</span></span>$<span class="token punctuation">{</span>info<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> : &#39;&#39;) + info.path,
            textColor: 0,
            tooltip: &#39;This component is rendered by &amp;lt;router-view&amp;gt;&#39;,
            backgroundColor: PINK_500,
          });
        }
        // if multiple useLink are used
        if (Array.isArray(componentInstance.__vrl_devtools)) {
          componentInstance.__devtoolsApi = api;
          componentInstance.__vrl_devtools.forEach((devtoolsData) =&gt; {
            let backgroundColor = ORANGE_400;
            let tooltip = &#39;&#39;;
            if (devtoolsData.isExactActive) {
              backgroundColor = LIME_500;
              tooltip = &#39;This is exactly active&#39;;
            } else if (devtoolsData.isActive) {
              backgroundColor = BLUE_600;
              tooltip = &#39;This link is active&#39;;
            }
            node.tags.push({
              label: devtoolsData.route.path,
              textColor: 0,
              tooltip,
              backgroundColor,
            });
          });
        }
      });
      watch(router.currentRoute, () =&gt; {
        // refresh active state
        refreshRoutesView();
        api.notifyComponentUpdate();
        api.sendInspectorTree(routerInspectorId);
        api.sendInspectorState(routerInspectorId);
      });
      const navigationsLayerId = &#39;router:navigations:&#39; + id;
      api.addTimelineLayer({
        id: navigationsLayerId,
        label: </span><span class="token template-punctuation string">`</span></span>Router$<span class="token punctuation">{</span>id <span class="token operator">?</span> <span class="token string">&#39; &#39;</span> <span class="token operator">+</span> id <span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">}</span> Navigations<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">,
        color: 0x40a8c4,
      });
      // const errorsLayerId = &#39;router:errors&#39;
      // api.addTimelineLayer({
      //   id: errorsLayerId,
      //   label: &#39;Router Errors&#39;,
      //   color: 0xea5455,
      // })
      router.onError((error, to) =&gt; {
        api.addTimelineEvent({
          layerId: navigationsLayerId,
          event: {
            title: &#39;Error during Navigation&#39;,
            subtitle: to.fullPath,
            logType: &#39;error&#39;,
            time: Date.now(),
            data: { error },
            groupId: to.meta.__navigationId,
          },
        });
      });
      // attached to </span><span class="token template-punctuation string">`</span></span>meta<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> and used to group events
      let navigationId = 0;
      router.beforeEach((to, from) =&gt; {
        const data = {
          guard: formatDisplay(&#39;beforeEach&#39;),
          from: formatRouteLocation(
            from,
            &#39;Current Location during this navigation&#39;
          ),
          to: formatRouteLocation(to, &#39;Target location&#39;),
        };
        // Used to group navigations together, hide from devtools
        Object.defineProperty(to.meta, &#39;__navigationId&#39;, {
          value: navigationId++,
        });
        api.addTimelineEvent({
          layerId: navigationsLayerId,
          event: {
            time: Date.now(),
            title: &#39;Start of navigation&#39;,
            subtitle: to.fullPath,
            data,
            groupId: to.meta.__navigationId,
          },
        });
      });
      router.afterEach((to, from, failure) =&gt; {
        const data = {
          guard: formatDisplay(&#39;afterEach&#39;),
        };
        if (failure) {
          data.failure = {
            _custom: {
              type: Error,
              readOnly: true,
              display: failure ? failure.message : &#39;&#39;,
              tooltip: &#39;Navigation Failure&#39;,
              value: failure,
            },
          };
          data.status = formatDisplay(&#39;❌&#39;);
        } else {
          data.status = formatDisplay(&#39;✅&#39;);
        }
        // we set here to have the right order
        data.from = formatRouteLocation(
          from,
          &#39;Current Location during this navigation&#39;
        );
        data.to = formatRouteLocation(to, &#39;Target location&#39;);
        api.addTimelineEvent({
          layerId: navigationsLayerId,
          event: {
            title: &#39;End of navigation&#39;,
            subtitle: to.fullPath,
            time: Date.now(),
            data,
            logType: failure ? &#39;warning&#39; : &#39;default&#39;,
            groupId: to.meta.__navigationId,
          },
        });
      });
      /**
       * Inspector of Existing routes
       */
      const routerInspectorId = &#39;router-inspector:&#39; + id;
      api.addInspector({
        id: routerInspectorId,
        label: &#39;Routes&#39; + (id ? &#39; &#39; + id : &#39;&#39;),
        icon: &#39;book&#39;,
        treeFilterPlaceholder: &#39;Search routes&#39;,
      });
      function refreshRoutesView() {
        // the routes view isn&#39;t active
        if (!activeRoutesPayload) return;
        const payload = activeRoutesPayload;
        // children routes will appear as nested
        let routes = matcher.getRoutes().filter((route) =&gt; !route.parent);
        // reset match state to false
        routes.forEach(resetMatchStateOnRouteRecord);
        // apply a match state if there is a payload
        if (payload.filter) {
          routes = routes.filter((route) =&gt;
            // save matches state based on the payload
            isRouteMatching(route, payload.filter.toLowerCase())
          );
        }
        // mark active routes
        routes.forEach((route) =&gt;
          markRouteRecordActive(route, router.currentRoute.value)
        );
        payload.rootNodes = routes.map(formatRouteRecordForInspector);
      }
      let activeRoutesPayload;
      api.on.getInspectorTree((payload) =&gt; {
        activeRoutesPayload = payload;
        if (payload.app === app &amp;&amp; payload.inspectorId === routerInspectorId) {
          refreshRoutesView();
        }
      });
      /**
       * Display information about the currently selected route record
       */
      api.on.getInspectorState((payload) =&gt; {
        if (payload.app === app &amp;&amp; payload.inspectorId === routerInspectorId) {
          const routes = matcher.getRoutes();
          const route = routes.find(
            (route) =&gt; route.record.__vd_id === payload.nodeId
          );
          if (route) {
            payload.state = {
              options: formatRouteRecordMatcherForStateInspector(route),
            };
          }
        }
      });
      api.sendInspectorTree(routerInspectorId);
      api.sendInspectorState(routerInspectorId);
    }
  );
}
function modifierForKey(key) {
  if (key.optional) {
    return key.repeatable ? &#39;*&#39; : &#39;?&#39;;
  } else {
    return key.repeatable ? &#39;+&#39; : &#39;&#39;;
  }
}
function formatRouteRecordMatcherForStateInspector(route) {
  const { record } = route;
  const fields = [{ editable: false, key: &#39;path&#39;, value: record.path }];
  if (record.name != null) {
    fields.push({
      editable: false,
      key: &#39;name&#39;,
      value: record.name,
    });
  }
  fields.push({ editable: false, key: &#39;regexp&#39;, value: route.re });
  if (route.keys.length) {
    fields.push({
      editable: false,
      key: &#39;keys&#39;,
      value: {
        _custom: {
          type: null,
          readOnly: true,
          display: route.keys
            .map((key) =&gt; </span><span class="token template-punctuation string">`</span></span>$<span class="token punctuation">{</span>key<span class="token punctuation">.</span>name<span class="token punctuation">}</span>$<span class="token punctuation">{</span><span class="token function">modifierForKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">)
            .join(&#39; &#39;),
          tooltip: &#39;Param keys&#39;,
          value: route.keys,
        },
      },
    });
  }
  if (record.redirect != null) {
    fields.push({
      editable: false,
      key: &#39;redirect&#39;,
      value: record.redirect,
    });
  }
  if (route.alias.length) {
    fields.push({
      editable: false,
      key: &#39;aliases&#39;,
      value: route.alias.map((alias) =&gt; alias.record.path),
    });
  }
  fields.push({
    key: &#39;score&#39;,
    editable: false,
    value: {
      _custom: {
        type: null,
        readOnly: true,
        display: route.score.map((score) =&gt; score.join(&#39;, &#39;)).join(&#39; | &#39;),
        tooltip: &#39;Score used to sort routes&#39;,
        value: route.score,
      },
    },
  });
  return fields;
}
/**
 * Extracted from tailwind palette
 */
const PINK_500 = 0xec4899;
const BLUE_600 = 0x2563eb;
const LIME_500 = 0x84cc16;
const CYAN_400 = 0x22d3ee;
const ORANGE_400 = 0xfb923c;
// const GRAY_100 = 0xf4f4f5
const DARK = 0x666666;
function formatRouteRecordForInspector(route) {
  const tags = [];
  const { record } = route;
  if (record.name != null) {
    tags.push({
      label: String(record.name),
      textColor: 0,
      backgroundColor: CYAN_400,
    });
  }
  if (record.aliasOf) {
    tags.push({
      label: &#39;alias&#39;,
      textColor: 0,
      backgroundColor: ORANGE_400,
    });
  }
  if (route.__vd_match) {
    tags.push({
      label: &#39;matches&#39;,
      textColor: 0,
      backgroundColor: PINK_500,
    });
  }
  if (route.__vd_exactActive) {
    tags.push({
      label: &#39;exact&#39;,
      textColor: 0,
      backgroundColor: LIME_500,
    });
  }
  if (route.__vd_active) {
    tags.push({
      label: &#39;active&#39;,
      textColor: 0,
      backgroundColor: BLUE_600,
    });
  }
  if (record.redirect) {
    tags.push({
      label:
        &#39;redirect: &#39; +
        (typeof record.redirect === &#39;string&#39; ? record.redirect : &#39;Object&#39;),
      textColor: 0xffffff,
      backgroundColor: DARK,
    });
  }
  // add an id to be able to select it. Using the </span><span class="token template-punctuation string">`</span></span>path<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"> is not possible because
  // empty path children would collide with their parents
  let id = record.__vd_id;
  if (id == null) {
    id = String(routeRecordId++);
    record.__vd_id = id;
  }
  return {
    id,
    label: record.path,
    tags,
    children: route.children.map(formatRouteRecordForInspector),
  };
}
//  incremental id for route records and inspector state
let routeRecordId = 0;
const EXTRACT_REGEXP_RE = /^\/(.*)\/([a-z]*)$/;
function markRouteRecordActive(route, currentRoute) {
  // no route will be active if matched is empty
  // reset the matching state
  const isExactActive =
    currentRoute.matched.length &amp;&amp;
    isSameRouteRecord(
      currentRoute.matched[currentRoute.matched.length - 1],
      route.record
    );
  route.__vd_exactActive = route.__vd_active = isExactActive;
  if (!isExactActive) {
    route.__vd_active = currentRoute.matched.some((match) =&gt;
      isSameRouteRecord(match, route.record)
    );
  }
  route.children.forEach((childRoute) =&gt;
    markRouteRecordActive(childRoute, currentRoute)
  );
}
function resetMatchStateOnRouteRecord(route) {
  route.__vd_match = false;
  route.children.forEach(resetMatchStateOnRouteRecord);
}
function isRouteMatching(route, filter) {
  const found = String(route.re).match(EXTRACT_REGEXP_RE);
  route.__vd_match = false;
  if (!found || found.length &lt; 3) {
    return false;
  }
  // use a regexp without $ at the end to match nested routes better
  const nonEndingRE = new RegExp(found[1].replace(/\$/, &#39;&#39;), found[2]);
  if (nonEndingRE.test(filter)) {
    // mark children as matches
    route.children.forEach((child) =&gt; isRouteMatching(child, filter));
    // exception case: </span><span class="token template-punctuation string">`</span></span><span class="token operator">/</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    if (route.record.path !== &#39;/&#39; || filter === &#39;/&#39;) {
      route.__vd_match = route.re.test(filter);
      return true;
    }
    // hide the / route
    return false;
  }
  const path = route.record.path.toLowerCase();
  const decodedPath = decode(path);
  // also allow partial matching on the path
  if (
    !filter.startsWith(&#39;/&#39;) &amp;&amp;
    (decodedPath.includes(filter) || path.includes(filter))
  )
    return true;
  if (decodedPath.startsWith(filter) || path.startsWith(filter)) return true;
  if (route.record.name &amp;&amp; String(route.record.name).includes(filter))
    return true;
  return route.children.some((child) =&gt; isRouteMatching(child, filter));
}
function omit(obj, keys) {
  const ret = {};
  for (const key in obj) {
    if (!keys.includes(key)) {
      // @ts-expect-error
      ret[key] = obj[key];
    }
  }
  return ret;
}

/**
 * Creates a Router instance that can be used by a Vue app.
 *
 * @param options - {@link RouterOptions}
 */
function createRouter(options) {
  const matcher = createRouterMatcher(options.routes, options);
  const parseQuery$1 = options.parseQuery || parseQuery;
  const stringifyQuery$1 = options.stringifyQuery || stringifyQuery;
  const routerHistory = options.history;
  if (!routerHistory)
    throw new Error(
      &#39;Provide the &quot;history&quot; option when calling &quot;createRouter()&quot;:&#39; +
        &#39; https://next.router.vuejs.org/api/#history.&#39;
    );
  const beforeGuards = useCallbacks();
  const beforeResolveGuards = useCallbacks();
  const afterGuards = useCallbacks();
  const currentRoute = shallowRef(START_LOCATION_NORMALIZED);
  let pendingLocation = START_LOCATION_NORMALIZED;
  // leave the scrollRestoration if no scrollBehavior is provided
  if (isBrowser &amp;&amp; options.scrollBehavior &amp;&amp; &#39;scrollRestoration&#39; in history) {
    history.scrollRestoration = &#39;manual&#39;;
  }
  const normalizeParams = applyToParams.bind(
    null,
    (paramValue) =&gt; &#39;&#39; + paramValue
  );
  const encodeParams = applyToParams.bind(null, encodeParam);
  const decodeParams =
    // @ts-expect-error: intentionally avoid the type check
    applyToParams.bind(null, decode);
  function addRoute(parentOrRoute, route) {
    let parent;
    let record;
    if (isRouteName(parentOrRoute)) {
      parent = matcher.getRecordMatcher(parentOrRoute);
      record = route;
    } else {
      record = parentOrRoute;
    }
    return matcher.addRoute(record, parent);
  }
  function removeRoute(name) {
    const recordMatcher = matcher.getRecordMatcher(name);
    if (recordMatcher) {
      matcher.removeRoute(recordMatcher);
    } else {
      warn(</span><span class="token template-punctuation string">`</span></span>Cannot remove non<span class="token operator">-</span>existent route <span class="token string">&quot;${String(name)}&quot;</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">);
    }
  }
  function getRoutes() {
    return matcher.getRoutes().map((routeMatcher) =&gt; routeMatcher.record);
  }
  function hasRoute(name) {
    return !!matcher.getRecordMatcher(name);
  }
  function resolve(rawLocation, currentLocation) {
    // const objectLocation = routerLocationAsObject(rawLocation)
    // we create a copy to modify it later
    currentLocation = assign({}, currentLocation || currentRoute.value);
    if (typeof rawLocation === &#39;string&#39;) {
      const locationNormalized = parseURL(
        parseQuery$1,
        rawLocation,
        currentLocation.path
      );
      const matchedRoute = matcher.resolve(
        { path: locationNormalized.path },
        currentLocation
      );
      const href = routerHistory.createHref(locationNormalized.fullPath);
      {
        if (href.startsWith(&#39;//&#39;))
          warn(
            </span><span class="token template-punctuation string">`</span></span>Location <span class="token string">&quot;${rawLocation}&quot;</span> resolved to <span class="token string">&quot;${href}&quot;</span><span class="token punctuation">.</span> <span class="token constant">A</span> resolved location cannot start <span class="token keyword">with</span> multiple slashes<span class="token punctuation">.</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
          );
        else if (!matchedRoute.matched.length) {
          warn(</span><span class="token template-punctuation string">`</span></span>No match found <span class="token keyword">for</span> location <span class="token keyword">with</span> path <span class="token string">&quot;${rawLocation}&quot;</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">);
        }
      }
      // locationNormalized is always a new object
      return assign(locationNormalized, matchedRoute, {
        params: decodeParams(matchedRoute.params),
        hash: decode(locationNormalized.hash),
        redirectedFrom: undefined,
        href,
      });
    }
    let matcherLocation;
    // path could be relative in object as well
    if (&#39;path&#39; in rawLocation) {
      if (
        &#39;params&#39; in rawLocation &amp;&amp;
        !(&#39;name&#39; in rawLocation) &amp;&amp;
        // @ts-expect-error: the type is never
        Object.keys(rawLocation.params).length
      ) {
        warn(
          </span><span class="token template-punctuation string">`</span></span>Path &quot;$<span class="token punctuation">{</span>
            <span class="token comment">// @ts-expect-error: the type is never</span>
            rawLocation<span class="token punctuation">.</span>path
          <span class="token punctuation">}</span>&quot; was passed <span class="token keyword">with</span> params but they will be ignored<span class="token punctuation">.</span> Use a named route alongside params instead<span class="token punctuation">.</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
        );
      }
      matcherLocation = assign({}, rawLocation, {
        path: parseURL(parseQuery$1, rawLocation.path, currentLocation.path)
          .path,
      });
    } else {
      // remove any nullish param
      const targetParams = assign({}, rawLocation.params);
      for (const key in targetParams) {
        if (targetParams[key] == null) {
          delete targetParams[key];
        }
      }
      // pass encoded values to the matcher so it can produce encoded path and fullPath
      matcherLocation = assign({}, rawLocation, {
        params: encodeParams(rawLocation.params),
      });
      // current location params are decoded, we need to encode them in case the
      // matcher merges the params
      currentLocation.params = encodeParams(currentLocation.params);
    }
    const matchedRoute = matcher.resolve(matcherLocation, currentLocation);
    const hash = rawLocation.hash || &#39;&#39;;
    if (hash &amp;&amp; !hash.startsWith(&#39;#&#39;)) {
      warn(
        </span><span class="token template-punctuation string">`</span></span><span class="token constant">A</span> \<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hash\` should always start with the character &quot;#&quot;. Replace &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hash<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; with &quot;#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>hash<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;.</span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// decoding them) the matcher might have merged current location params so</span>
    <span class="token comment">// we need to run the decoding again</span>
    matchedRoute<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token function">normalizeParams</span><span class="token punctuation">(</span><span class="token function">decodeParams</span><span class="token punctuation">(</span>matchedRoute<span class="token punctuation">.</span>params<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> fullPath <span class="token operator">=</span> <span class="token function">stringifyURL</span><span class="token punctuation">(</span>
      stringifyQuery$<span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> rawLocation<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        hash<span class="token operator">:</span> <span class="token function">encodeHash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span><span class="token punctuation">,</span>
        path<span class="token operator">:</span> matchedRoute<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> href <span class="token operator">=</span> routerHistory<span class="token punctuation">.</span><span class="token function">createHref</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>href<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&#39;//&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Location &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>rawLocation<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; resolved to &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>href<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. A resolved location cannot start with multiple slashes.</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matchedRoute<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">No match found for location with path &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
            <span class="token string">&#39;path&#39;</span> <span class="token keyword">in</span> rawLocation <span class="token operator">?</span> rawLocation<span class="token punctuation">.</span>path <span class="token operator">:</span> rawLocation
          <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">assign</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        fullPath<span class="token punctuation">,</span>
        <span class="token comment">// keep the hash encoded so fullPath is effectively path + encodedQuery +</span>
        <span class="token comment">// hash</span>
        hash<span class="token punctuation">,</span>
        query<span class="token operator">:</span>
          <span class="token comment">// if the user is using a custom query lib like qs, we might have</span>
          <span class="token comment">// nested objects, so we keep the query as is, meaning it can contain</span>
          <span class="token comment">// numbers at `$route.query`, but at the point, the user will have to</span>
          <span class="token comment">// use their own type anyway.</span>
          <span class="token comment">// https://github.com/vuejs/vue-router-next/issues/328#issuecomment-649481567</span>
          stringifyQuery$<span class="token number">1</span> <span class="token operator">===</span> stringifyQuery
            <span class="token operator">?</span> <span class="token function">normalizeQuery</span><span class="token punctuation">(</span>rawLocation<span class="token punctuation">.</span>query<span class="token punctuation">)</span>
            <span class="token operator">:</span> rawLocation<span class="token punctuation">.</span>query <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      matchedRoute<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        redirectedFrom<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
        href<span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">locationAsObject</span><span class="token punctuation">(</span><span class="token parameter">to</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">typeof</span> to <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span>
      <span class="token operator">?</span> <span class="token function">parseURL</span><span class="token punctuation">(</span>parseQuery$<span class="token number">1</span><span class="token punctuation">,</span> to<span class="token punctuation">,</span> currentRoute<span class="token punctuation">.</span>value<span class="token punctuation">.</span>path<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">checkCanceledNavigation</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingLocation <span class="token operator">!==</span> to<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">createRouterError</span><span class="token punctuation">(</span><span class="token number">8</span> <span class="token comment">/* NAVIGATION_CANCELLED */</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        from<span class="token punctuation">,</span>
        to<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">to</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token parameter">to</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token function">locationAsObject</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> replace<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">handleRedirectRecord</span><span class="token punctuation">(</span><span class="token parameter">to</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> lastMatched <span class="token operator">=</span> to<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>to<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lastMatched <span class="token operator">&amp;&amp;</span> lastMatched<span class="token punctuation">.</span>redirect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> redirect <span class="token punctuation">}</span> <span class="token operator">=</span> lastMatched<span class="token punctuation">;</span>
      <span class="token keyword">let</span> newTargetLocation <span class="token operator">=</span>
        <span class="token keyword">typeof</span> redirect <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span> <span class="token operator">?</span> <span class="token function">redirect</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span> <span class="token operator">:</span> redirect<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> newTargetLocation <span class="token operator">===</span> <span class="token string">&#39;string&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        newTargetLocation <span class="token operator">=</span>
          newTargetLocation<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;?&#39;</span><span class="token punctuation">)</span> <span class="token operator">||</span> newTargetLocation<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">&#39;#&#39;</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> <span class="token punctuation">(</span>newTargetLocation <span class="token operator">=</span> <span class="token function">locationAsObject</span><span class="token punctuation">(</span>newTargetLocation<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token comment">// force empty params</span>
              <span class="token punctuation">{</span> path<span class="token operator">:</span> newTargetLocation <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// @ts-expect-error: force empty params when a string is passed to let</span>
        <span class="token comment">// the router parse them again</span>
        newTargetLocation<span class="token punctuation">.</span>params <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span> <span class="token keyword">in</span> newTargetLocation<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span> <span class="token keyword">in</span> newTargetLocation<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span>
          <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid redirect found:\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>
            newTargetLocation<span class="token punctuation">,</span>
            <span class="token keyword">null</span><span class="token punctuation">,</span>
            <span class="token number">2</span>
          <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n when navigating to &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
            to<span class="token punctuation">.</span>fullPath
          <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. A redirect must contain a name or path. This will break in production.</span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;Invalid redirect&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token function">assign</span><span class="token punctuation">(</span>
        <span class="token punctuation">{</span>
          query<span class="token operator">:</span> to<span class="token punctuation">.</span>query<span class="token punctuation">,</span>
          hash<span class="token operator">:</span> to<span class="token punctuation">.</span>hash<span class="token punctuation">,</span>
          params<span class="token operator">:</span> to<span class="token punctuation">.</span>params<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        newTargetLocation
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> redirectedFrom</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> targetLocation <span class="token operator">=</span> <span class="token punctuation">(</span>pendingLocation <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> from <span class="token operator">=</span> currentRoute<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">const</span> data <span class="token operator">=</span> to<span class="token punctuation">.</span>state<span class="token punctuation">;</span>
    <span class="token keyword">const</span> force <span class="token operator">=</span> to<span class="token punctuation">.</span>force<span class="token punctuation">;</span>
    <span class="token comment">// to could be a string where `replace` is a function</span>
    <span class="token keyword">const</span> replace <span class="token operator">=</span> to<span class="token punctuation">.</span>replace <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> shouldRedirect <span class="token operator">=</span> <span class="token function">handleRedirectRecord</span><span class="token punctuation">(</span>targetLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldRedirect<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span>
        <span class="token function">assign</span><span class="token punctuation">(</span><span class="token function">locationAsObject</span><span class="token punctuation">(</span>shouldRedirect<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
          state<span class="token operator">:</span> data<span class="token punctuation">,</span>
          force<span class="token punctuation">,</span>
          replace<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// keep original redirectedFrom if it exists</span>
        redirectedFrom <span class="token operator">||</span> targetLocation
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// if it was a redirect we already called `pushWithRedirect` above</span>
    <span class="token keyword">const</span> toLocation <span class="token operator">=</span> targetLocation<span class="token punctuation">;</span>
    toLocation<span class="token punctuation">.</span>redirectedFrom <span class="token operator">=</span> redirectedFrom<span class="token punctuation">;</span>
    <span class="token keyword">let</span> failure<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>force <span class="token operator">&amp;&amp;</span> <span class="token function">isSameRouteLocation</span><span class="token punctuation">(</span>stringifyQuery$<span class="token number">1</span><span class="token punctuation">,</span> from<span class="token punctuation">,</span> targetLocation<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      failure <span class="token operator">=</span> <span class="token function">createRouterError</span><span class="token punctuation">(</span><span class="token number">16</span> <span class="token comment">/* NAVIGATION_DUPLICATED */</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        to<span class="token operator">:</span> toLocation<span class="token punctuation">,</span>
        from<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// trigger scroll to allow scrolling to the same anchor</span>
      <span class="token function">handleScroll</span><span class="token punctuation">(</span>
        from<span class="token punctuation">,</span>
        from<span class="token punctuation">,</span>
        <span class="token comment">// this is a push, the only way for it to be triggered from a</span>
        <span class="token comment">// history.listen is with a redirect, which makes it become a push</span>
        <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token comment">// This cannot be the first navigation because the initial location</span>
        <span class="token comment">// cannot be manually navigated to</span>
        <span class="token boolean">false</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>failure <span class="token operator">?</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>failure<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">navigate</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token operator">?</span> error
          <span class="token operator">:</span> <span class="token comment">// reject any unknown error</span>
            <span class="token function">triggerError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> toLocation<span class="token punctuation">,</span> from<span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">failure</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>failure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>failure<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token comment">/* NAVIGATION_GUARD_REDIRECT */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>
              <span class="token comment">// we are redirecting to the same location we were already at</span>
              <span class="token function">isSameRouteLocation</span><span class="token punctuation">(</span>
                stringifyQuery$<span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>failure<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">,</span>
                toLocation
              <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
              <span class="token comment">// and we have done it a couple of times</span>
              redirectedFrom <span class="token operator">&amp;&amp;</span>
              <span class="token comment">// @ts-expect-error: added only in dev</span>
              <span class="token punctuation">(</span>redirectedFrom<span class="token punctuation">.</span>_count <span class="token operator">=</span> redirectedFrom<span class="token punctuation">.</span>_count
                <span class="token operator">?</span> <span class="token comment">// @ts-expect-error</span>
                  redirectedFrom<span class="token punctuation">.</span>_count <span class="token operator">+</span> <span class="token number">1</span>
                <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">warn</span><span class="token punctuation">(</span>
                <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Detected an infinite redirection in a navigation guard when going from &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>from<span class="token punctuation">.</span>fullPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; to &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>toLocation<span class="token punctuation">.</span>fullPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;. Aborting to avoid a Stack Overflow. This will break in production if not fixed.</span><span class="token template-punctuation string">`</span></span>
              <span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;Infinite redirect in navigation guard&#39;</span><span class="token punctuation">)</span>
              <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span>
              <span class="token comment">// keep options</span>
              <span class="token function">assign</span><span class="token punctuation">(</span><span class="token function">locationAsObject</span><span class="token punctuation">(</span>failure<span class="token punctuation">.</span>to<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                state<span class="token operator">:</span> data<span class="token punctuation">,</span>
                force<span class="token punctuation">,</span>
                replace<span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token comment">// preserve the original redirectedFrom if any</span>
              redirectedFrom <span class="token operator">||</span> toLocation
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// if we fail we don&#39;t finalize the navigation</span>
          failure <span class="token operator">=</span> <span class="token function">finalizeNavigation</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">,</span> from<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> replace<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">triggerAfterEach</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">,</span> from<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> failure<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token doc-comment comment">/**
   * Helper to reject and skip all navigation guards if a new navigation happened
   * <span class="token keyword">@param</span> <span class="token parameter">to</span>
   * <span class="token keyword">@param</span> <span class="token parameter">from</span>
   */</span>
  <span class="token keyword">function</span> <span class="token function">checkCanceledNavigationAndReject</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token function">checkCanceledNavigation</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> error <span class="token operator">?</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">:</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// TODO: refactor the whole before guards by internally using router.beforeEach</span>
  <span class="token keyword">function</span> <span class="token function">navigate</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> guards<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>leavingRecords<span class="token punctuation">,</span> updatingRecords<span class="token punctuation">,</span> enteringRecords<span class="token punctuation">]</span> <span class="token operator">=</span>
      <span class="token function">extractChangingRecords</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// all components here have been resolved once because we are leaving</span>
    guards <span class="token operator">=</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
      leavingRecords<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">&#39;beforeRouteLeave&#39;</span><span class="token punctuation">,</span>
      to<span class="token punctuation">,</span>
      from
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// leavingRecords is already reversed</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> leavingRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      record<span class="token punctuation">.</span>leaveGuards<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">guard</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> canceledNavigationCheck <span class="token operator">=</span> <span class="token function">checkCanceledNavigationAndReject</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span>
      to<span class="token punctuation">,</span>
      from
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// run the queue of per route beforeRouteLeave guards</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// check global guards beforeEach</span>
          guards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> guard <span class="token keyword">of</span> beforeGuards<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// check in components beforeRouteUpdate</span>
          guards <span class="token operator">=</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
            updatingRecords<span class="token punctuation">,</span>
            <span class="token string">&#39;beforeRouteUpdate&#39;</span><span class="token punctuation">,</span>
            to<span class="token punctuation">,</span>
            from
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> updatingRecords<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            record<span class="token punctuation">.</span>updateGuards<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">guard</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// run the queue of per route beforeEnter guards</span>
          <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// check the route beforeEnter</span>
          guards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> record <span class="token keyword">of</span> to<span class="token punctuation">.</span>matched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// do not trigger beforeEnter on reused views</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>beforeEnter <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>from<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> beforeEnter <span class="token keyword">of</span> record<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">)</span>
                  guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>beforeEnter<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span>beforeEnter<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// run the queue of per route beforeEnter guards</span>
          <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// NOTE: at this point to.matched is normalized and does not contain any () =&gt; Promise&lt;Component&gt;</span>
          <span class="token comment">// clear existing enterCallbacks, these are added by extractComponentsGuards</span>
          to<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">record</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>record<span class="token punctuation">.</span>enterCallbacks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// check in-component beforeRouteEnter</span>
          guards <span class="token operator">=</span> <span class="token function">extractComponentsGuards</span><span class="token punctuation">(</span>
            enteringRecords<span class="token punctuation">,</span>
            <span class="token string">&#39;beforeRouteEnter&#39;</span><span class="token punctuation">,</span>
            to<span class="token punctuation">,</span>
            from
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// run the queue of per route beforeEnter guards</span>
          <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// check global guards beforeResolve</span>
          guards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> guard <span class="token keyword">of</span> beforeResolveGuards<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">guardToPromiseFn</span><span class="token punctuation">(</span>guard<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          guards<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>canceledNavigationCheck<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span>guards<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// catch any navigation canceled</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
          <span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token number">8</span> <span class="token comment">/* NAVIGATION_CANCELLED */</span><span class="token punctuation">)</span>
            <span class="token operator">?</span> err
            <span class="token operator">:</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">triggerAfterEach</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> failure</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// navigation is confirmed, call afterGuards</span>
    <span class="token comment">// TODO: wrap with error handlers</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> guard <span class="token keyword">of</span> afterGuards<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">guard</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token doc-comment comment">/**
   * - Cleans up any navigation guards
   * - Changes the url if necessary
   * - Calls the scrollBehavior
   */</span>
  <span class="token keyword">function</span> <span class="token function">finalizeNavigation</span><span class="token punctuation">(</span><span class="token parameter">toLocation<span class="token punctuation">,</span> from<span class="token punctuation">,</span> isPush<span class="token punctuation">,</span> replace<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// a more recent navigation took place</span>
    <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token function">checkCanceledNavigation</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">return</span> error<span class="token punctuation">;</span>
    <span class="token comment">// only consider as push if it&#39;s not the first navigation</span>
    <span class="token keyword">const</span> isFirstNavigation <span class="token operator">=</span> from <span class="token operator">===</span> <span class="token constant">START_LOCATION_NORMALIZED</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token operator">!</span>isBrowser <span class="token operator">?</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token operator">:</span> history<span class="token punctuation">.</span>state<span class="token punctuation">;</span>
    <span class="token comment">// change URL only if the user did a push/replace and if it&#39;s not the initial navigation because</span>
    <span class="token comment">// it&#39;s just reflecting the url</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isPush<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// on the initial navigation, we want to reuse the scroll position from</span>
      <span class="token comment">// history state if it exists</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>replace <span class="token operator">||</span> isFirstNavigation<span class="token punctuation">)</span>
        routerHistory<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
          toLocation<span class="token punctuation">.</span>fullPath<span class="token punctuation">,</span>
          <span class="token function">assign</span><span class="token punctuation">(</span>
            <span class="token punctuation">{</span>
              scroll<span class="token operator">:</span> isFirstNavigation <span class="token operator">&amp;&amp;</span> state <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span>scroll<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            data
          <span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> routerHistory<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">.</span>fullPath<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// accept current navigation</span>
    currentRoute<span class="token punctuation">.</span>value <span class="token operator">=</span> toLocation<span class="token punctuation">;</span>
    <span class="token function">handleScroll</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">,</span> from<span class="token punctuation">,</span> isPush<span class="token punctuation">,</span> isFirstNavigation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">markAsReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> removeHistoryListener<span class="token punctuation">;</span>
  <span class="token comment">// attach listener to history to trigger navigations</span>
  <span class="token keyword">function</span> <span class="token function">setupListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    removeHistoryListener <span class="token operator">=</span> routerHistory<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> _from<span class="token punctuation">,</span> info</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// cannot be a redirect route because it was in history</span>
      <span class="token keyword">const</span> toLocation <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// due to dynamic routing, and to hash history with manual navigation</span>
      <span class="token comment">// (manually changing the url or calling history.hash = &#39;#/somewhere&#39;),</span>
      <span class="token comment">// there could be a redirect record in history</span>
      <span class="token keyword">const</span> shouldRedirect <span class="token operator">=</span> <span class="token function">handleRedirectRecord</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldRedirect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span>
          <span class="token function">assign</span><span class="token punctuation">(</span>shouldRedirect<span class="token punctuation">,</span> <span class="token punctuation">{</span> replace<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          toLocation
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>noop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      pendingLocation <span class="token operator">=</span> toLocation<span class="token punctuation">;</span>
      <span class="token keyword">const</span> from <span class="token operator">=</span> currentRoute<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
      <span class="token comment">// TODO: should be moved to web history?</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">saveScrollPosition</span><span class="token punctuation">(</span>
          <span class="token function">getScrollKey</span><span class="token punctuation">(</span>from<span class="token punctuation">.</span>fullPath<span class="token punctuation">,</span> info<span class="token punctuation">.</span>delta<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">computeScrollPosition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">navigate</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">,</span> from<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>
            <span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>
              error<span class="token punctuation">,</span>
              <span class="token number">4</span> <span class="token comment">/* NAVIGATION_ABORTED */</span> <span class="token operator">|</span> <span class="token number">8</span> <span class="token comment">/* NAVIGATION_CANCELLED */</span>
            <span class="token punctuation">)</span>
          <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> error<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token comment">/* NAVIGATION_GUARD_REDIRECT */</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Here we could call if (info.delta) routerHistory.go(-info.delta,</span>
            <span class="token comment">// false) but this is bug prone as we have no way to wait the</span>
            <span class="token comment">// navigation to be finished before calling pushWithRedirect. Using</span>
            <span class="token comment">// a setTimeout of 16ms seems to work but there is not guarantee for</span>
            <span class="token comment">// it to work on every browser. So Instead we do not restore the</span>
            <span class="token comment">// history entry and trigger a new navigation as requested by the</span>
            <span class="token comment">// navigation guard.</span>
            <span class="token comment">// the error is already handled by router.push we just want to avoid</span>
            <span class="token comment">// logging the error</span>
            <span class="token function">pushWithRedirect</span><span class="token punctuation">(</span>
              error<span class="token punctuation">.</span>to<span class="token punctuation">,</span>
              toLocation
              <span class="token comment">// avoid an uncaught rejection, let push call triggerError</span>
            <span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">failure</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// manual change in hash history #916 ending up in the URL not</span>
                <span class="token comment">// changing but it was changed by the manual url change, so we</span>
                <span class="token comment">// need to manually change it ourselves</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>
                  <span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>
                    failure<span class="token punctuation">,</span>
                    <span class="token number">4</span> <span class="token comment">/* NAVIGATION_ABORTED */</span> <span class="token operator">|</span> <span class="token number">16</span> <span class="token comment">/* NAVIGATION_DUPLICATED */</span>
                  <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                  <span class="token operator">!</span>info<span class="token punctuation">.</span>delta <span class="token operator">&amp;&amp;</span>
                  info<span class="token punctuation">.</span>type <span class="token operator">===</span> NavigationType<span class="token punctuation">.</span>pop
                <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  routerHistory<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>noop<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// avoid the then branch</span>
            <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// do not restore history on unknown direction</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>delta<span class="token punctuation">)</span> routerHistory<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token operator">-</span>info<span class="token punctuation">.</span>delta<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// unrecognized error, transfer to the global handler</span>
          <span class="token keyword">return</span> <span class="token function">triggerError</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> toLocation<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">failure</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          failure <span class="token operator">=</span>
            failure <span class="token operator">||</span>
            <span class="token function">finalizeNavigation</span><span class="token punctuation">(</span>
              <span class="token comment">// after navigation, all matched components are resolved</span>
              toLocation<span class="token punctuation">,</span>
              from<span class="token punctuation">,</span>
              <span class="token boolean">false</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// revert the navigation</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>failure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token punctuation">.</span>delta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              routerHistory<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token operator">-</span>info<span class="token punctuation">.</span>delta<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
              info<span class="token punctuation">.</span>type <span class="token operator">===</span> NavigationType<span class="token punctuation">.</span>pop <span class="token operator">&amp;&amp;</span>
              <span class="token function">isNavigationFailure</span><span class="token punctuation">(</span>
                failure<span class="token punctuation">,</span>
                <span class="token number">4</span> <span class="token comment">/* NAVIGATION_ABORTED */</span> <span class="token operator">|</span> <span class="token number">16</span> <span class="token comment">/* NAVIGATION_DUPLICATED */</span>
              <span class="token punctuation">)</span>
            <span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// manual change in hash history #916</span>
              <span class="token comment">// it&#39;s like a push but lacks the information of the direction</span>
              routerHistory<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token function">triggerAfterEach</span><span class="token punctuation">(</span>toLocation<span class="token punctuation">,</span> from<span class="token punctuation">,</span> failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>noop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Initialization and Errors</span>
  <span class="token keyword">let</span> readyHandlers <span class="token operator">=</span> <span class="token function">useCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> errorHandlers <span class="token operator">=</span> <span class="token function">useCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> ready<span class="token punctuation">;</span>
  <span class="token doc-comment comment">/**
   * Trigger errorHandlers added via onError and throws the error as well
   *
   * <span class="token keyword">@param</span> <span class="token parameter">error</span> - error to throw
   * <span class="token keyword">@param</span> <span class="token parameter">to</span> - location we were navigating to when the error happened
   * <span class="token keyword">@param</span> <span class="token parameter">from</span> - location we were navigating from when the error happened
   * <span class="token keyword">@returns</span> the error as a rejected promise
   */</span>
  <span class="token keyword">function</span> <span class="token function">triggerError</span><span class="token punctuation">(</span><span class="token parameter">error<span class="token punctuation">,</span> to<span class="token punctuation">,</span> <span class="token keyword">from</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">markAsReady</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> list <span class="token operator">=</span> errorHandlers<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>list<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">handler</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">handler</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token punctuation">{</span>
        <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&#39;uncaught error during route navigation:&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">isReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ready <span class="token operator">&amp;&amp;</span> currentRoute<span class="token punctuation">.</span>value <span class="token operator">!==</span> <span class="token constant">START_LOCATION_NORMALIZED</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      readyHandlers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">[</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token doc-comment comment">/**
   * Mark the router as ready, resolving the promised returned by isReady(). Can
   * only be called once, otherwise does nothing.
   * <span class="token keyword">@param</span> <span class="token parameter">err</span> - optional error
   */</span>
  <span class="token keyword">function</span> <span class="token function">markAsReady</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ready<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    ready <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">setupListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    readyHandlers
      <span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>err <span class="token operator">?</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    readyHandlers<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Scroll behavior</span>
  <span class="token keyword">function</span> <span class="token function">handleScroll</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> isPush<span class="token punctuation">,</span> isFirstNavigation</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> scrollBehavior <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isBrowser <span class="token operator">||</span> <span class="token operator">!</span>scrollBehavior<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> scrollPosition <span class="token operator">=</span>
      <span class="token punctuation">(</span><span class="token operator">!</span>isPush <span class="token operator">&amp;&amp;</span> <span class="token function">getSavedScrollPosition</span><span class="token punctuation">(</span><span class="token function">getScrollKey</span><span class="token punctuation">(</span>to<span class="token punctuation">.</span>fullPath<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>isFirstNavigation <span class="token operator">||</span> <span class="token operator">!</span>isPush<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        history<span class="token punctuation">.</span>state <span class="token operator">&amp;&amp;</span>
        history<span class="token punctuation">.</span>state<span class="token punctuation">.</span>scroll<span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">nextTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">scrollBehavior</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> from<span class="token punctuation">,</span> scrollPosition<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">position</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> position <span class="token operator">&amp;&amp;</span> <span class="token function">scrollToPosition</span><span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">triggerError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> to<span class="token punctuation">,</span> from<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token function-variable function">go</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">delta</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> routerHistory<span class="token punctuation">.</span><span class="token function">go</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> started<span class="token punctuation">;</span>
  <span class="token keyword">const</span> installedApps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token punctuation">{</span>
    currentRoute<span class="token punctuation">,</span>
    addRoute<span class="token punctuation">,</span>
    removeRoute<span class="token punctuation">,</span>
    hasRoute<span class="token punctuation">,</span>
    getRoutes<span class="token punctuation">,</span>
    resolve<span class="token punctuation">,</span>
    options<span class="token punctuation">,</span>
    push<span class="token punctuation">,</span>
    replace<span class="token punctuation">,</span>
    go<span class="token punctuation">,</span>
    <span class="token function-variable function">back</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">forward</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">go</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    beforeEach<span class="token operator">:</span> beforeGuards<span class="token punctuation">.</span>add<span class="token punctuation">,</span>
    beforeResolve<span class="token operator">:</span> beforeResolveGuards<span class="token punctuation">.</span>add<span class="token punctuation">,</span>
    afterEach<span class="token operator">:</span> afterGuards<span class="token punctuation">.</span>add<span class="token punctuation">,</span>
    onError<span class="token operator">:</span> errorHandlers<span class="token punctuation">.</span>add<span class="token punctuation">,</span>
    isReady<span class="token punctuation">,</span>
    <span class="token function">install</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">&#39;RouterLink&#39;</span><span class="token punctuation">,</span> RouterLink<span class="token punctuation">)</span><span class="token punctuation">;</span>
      app<span class="token punctuation">.</span><span class="token function">component</span><span class="token punctuation">(</span><span class="token string">&#39;RouterView&#39;</span><span class="token punctuation">,</span> RouterView<span class="token punctuation">)</span><span class="token punctuation">;</span>
      app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">.</span>$router <span class="token operator">=</span> router<span class="token punctuation">;</span>
      Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>globalProperties<span class="token punctuation">,</span> <span class="token string">&#39;$route&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">unref</span><span class="token punctuation">(</span>currentRoute<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// this initial navigation is only necessary on client, on server it doesn&#39;t</span>
      <span class="token comment">// make sense because it will create an extra unnecessary navigation and could</span>
      <span class="token comment">// lead to problems</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        isBrowser <span class="token operator">&amp;&amp;</span>
        <span class="token comment">// used for the initial navigation client side to avoid pushing</span>
        <span class="token comment">// multiple times when the router is used in multiple apps</span>
        <span class="token operator">!</span>started <span class="token operator">&amp;&amp;</span>
        currentRoute<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token constant">START_LOCATION_NORMALIZED</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// see above</span>
        started <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">push</span><span class="token punctuation">(</span>routerHistory<span class="token punctuation">.</span>location<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&#39;Unexpected error when starting the router:&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> reactiveRoute <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> <span class="token constant">START_LOCATION_NORMALIZED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// @ts-expect-error: the key matches</span>
        reactiveRoute<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> currentRoute<span class="token punctuation">.</span>value<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>routerKey<span class="token punctuation">,</span> router<span class="token punctuation">)</span><span class="token punctuation">;</span>
      app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>routeLocationKey<span class="token punctuation">,</span> <span class="token function">reactive</span><span class="token punctuation">(</span>reactiveRoute<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      app<span class="token punctuation">.</span><span class="token function">provide</span><span class="token punctuation">(</span>routerViewLocationKey<span class="token punctuation">,</span> currentRoute<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> unmountApp <span class="token operator">=</span> app<span class="token punctuation">.</span>unmount<span class="token punctuation">;</span>
      installedApps<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
      app<span class="token punctuation">.</span><span class="token function-variable function">unmount</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        installedApps<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// the router is not attached to an app anymore</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>installedApps<span class="token punctuation">.</span>size <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// invalidate the current navigation</span>
          pendingLocation <span class="token operator">=</span> <span class="token constant">START_LOCATION_NORMALIZED</span><span class="token punctuation">;</span>
          removeHistoryListener <span class="token operator">&amp;&amp;</span> <span class="token function">removeHistoryListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          currentRoute<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token constant">START_LOCATION_NORMALIZED</span><span class="token punctuation">;</span>
          started <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          ready <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">unmountApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isBrowser<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">addDevtools</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> router<span class="token punctuation">,</span> matcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> router<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">runGuardQueue</span><span class="token punctuation">(</span><span class="token parameter">guards</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> guards<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
    <span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> guard</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">guard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">extractChangingRecords</span><span class="token punctuation">(</span><span class="token parameter">to<span class="token punctuation">,</span> <span class="token keyword">from</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> leavingRecords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> updatingRecords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> enteringRecords <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> len <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>from<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length<span class="token punctuation">,</span> to<span class="token punctuation">.</span>matched<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> recordFrom <span class="token operator">=</span> from<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>recordFrom<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">record</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">isSameRouteRecord</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> recordFrom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        updatingRecords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>recordFrom<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> leavingRecords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>recordFrom<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> recordTo <span class="token operator">=</span> to<span class="token punctuation">.</span>matched<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>recordTo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// the type doesn&#39;t matter because we are comparing per reference</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>from<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">record</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">isSameRouteRecord</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> recordTo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        enteringRecords<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>recordTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>leavingRecords<span class="token punctuation">,</span> updatingRecords<span class="token punctuation">,</span> enteringRecords<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token doc-comment comment">/**
 * Returns the router instance. Equivalent to using `$router` inside
 * templates.
 */</span>
<span class="token keyword">function</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">inject</span><span class="token punctuation">(</span>routerKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token doc-comment comment">/**
 * Returns the current route location. Equivalent to using `$route` inside
 * templates.
 */</span>
<span class="token keyword">function</span> <span class="token function">useRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">inject</span><span class="token punctuation">(</span>routeLocationKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token punctuation">{</span>
  NavigationFailureType<span class="token punctuation">,</span>
  RouterLink<span class="token punctuation">,</span>
  RouterView<span class="token punctuation">,</span>
  <span class="token constant">START_LOCATION_NORMALIZED</span> <span class="token keyword">as</span> <span class="token constant">START_LOCATION</span><span class="token punctuation">,</span>
  createMemoryHistory<span class="token punctuation">,</span>
  createRouter<span class="token punctuation">,</span>
  createRouterMatcher<span class="token punctuation">,</span>
  createWebHashHistory<span class="token punctuation">,</span>
  createWebHistory<span class="token punctuation">,</span>
  isNavigationFailure<span class="token punctuation">,</span>
  matchedRouteKey<span class="token punctuation">,</span>
  onBeforeRouteLeave<span class="token punctuation">,</span>
  onBeforeRouteUpdate<span class="token punctuation">,</span>
  parseQuery<span class="token punctuation">,</span>
  routeLocationKey<span class="token punctuation">,</span>
  routerKey<span class="token punctuation">,</span>
  routerViewLocationKey<span class="token punctuation">,</span>
  stringifyQuery<span class="token punctuation">,</span>
  useLink<span class="token punctuation">,</span>
  useRoute<span class="token punctuation">,</span>
  useRouter<span class="token punctuation">,</span>
  viewDepthKey<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><!--]--></div><footer class="page-meta"><!----><!----><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 759227027@qq.com">tanyp</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.11f00557.js" defer></script>
  </body>
</html>
